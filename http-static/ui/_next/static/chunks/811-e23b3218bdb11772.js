"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[811],{7723:function(e,t,n){var r=n(9025);t.Z=(0,r.k)(e=>({dirtyInput:{backgroundColor:e.colors.blue[0]}}))},7219:function(e,t,n){n.d(t,{Mx:function(){return saveProcedure},_B:function(){return getDirtyValues},_N:function(){return useFormWithInitialUpdates},uA:function(){return makeInputPropsGen}});var r=n(966),a=n(7344),o=n(9956),i=n(9724),c=n(6680),s=n(7017),u=n(2922),l=n(1457),d=n(3900),p=n(9804);async function saveProcedure(e){(0,c.yK)("settings-save"),(0,c.c0)({id:"settings-save",withCloseButton:!0,autoClose:!1,loading:!0,icon:null,color:"orange",title:"Saving settings...",message:"Please wait while the new settings are applied..."});try{await e()}catch(e){(0,c.wD)({id:"settings-save",loading:!1,withCloseButton:!0,color:"red",icon:(0,r.jsx)(s.Z,{}),title:"Error saving settings",message:"There was an error saving settings. Please check form data and try again."}),console.error(e);return}(0,c.wD)({id:"settings-save",loading:!1,withCloseButton:!0,autoClose:1e3,color:"green",icon:(0,r.jsx)(u.Z,{}),title:"Settings saved",message:"Settings were saved and applied successfully."})}function makeInputPropsGen(e,t,n){return function(i){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"input",s=arguments.length>2?arguments[2]:void 0;return function(e,t,n,i,c){let s=e.getInputProps(t,n),u=c&&c>300;return{...s,classNames:{input:e.isDirty(t)&&i||void 0},inputContainer:u?e=>(0,r.jsxs)(r.Fragment,{children:[e,(0,r.jsxs)(a.Z,{spacing:3,c:"orange",mt:2,align:"center",children:[(0,r.jsx)(l.Z,{size:11,style:{marginTop:-1}}),(0,r.jsxs)(o.x,{fz:"xs",children:["Updated: ",(0,p.LU)(1e3*c)," ago."]})]})]}):void 0}}(e,i,{...n,type:c},t,s)}}function useFormWithInitialUpdates(e){let t=(0,i.c)(e);return(0,d.useEffect)(()=>{for(let n in t.values)t.isDirty(n)||t.setFieldValue(n,e.initialValues[n]);t.resetDirty({...e.initialValues})},[...Object.values(e.initialValues)]),t}function getDirtyValues(e){return Object.fromEntries(Object.entries(e.values).filter(t=>{let[n,r]=t;return e.isDirty(n)&&void 0!==r}))}},9342:function(e,t,n){n.d(t,{$b:function(){return readOpcbRegisters},EH:function(){return l},Gt:function(){return parseModbusLogRecord},J4:function(){return d},PW:function(){return sendModbusRequest},_:function(){return u},aL:function(){return genRtuRequest},eq:function(){return c},gY:function(){return genAsciiRequest},nM:function(){return genTcpRequest}});var r=n(52),a=n(9804),o=n(8431),i=n(8027).Buffer;let c=[{code:1,name:"Read Coils"},{code:2,name:"Read Discrete Inputs"},{code:3,name:"Read Holding Registers"},{code:4,name:"Read Input Registers"},{code:5,name:"Write Single Coil"},{code:6,name:"Write Single Register"},{code:7,name:"Read Exception Status"},{code:8,name:"Diagnostics"},{code:11,name:"Get Comm Event Counter"},{code:12,name:"Get Comm Event Log"},{code:15,name:"Write Multiple Coils"},{code:16,name:"Write Multiple Registers"},{code:17,name:"Report Server ID"},{code:20,name:"Read File Record"},{code:21,name:"Write File Record"},{code:22,name:"Mask Write Register"},{code:23,name:"Read/Write Multiple Registers"},{code:24,name:"Read FIFO Queue"},{code:43,name:"Read Device Identification"}],s=new Int32Array([0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448]),u=[50,75,110,134,150,200,300,600,1200,1800,2400,4800,9600,19200,38400,57600,115200,230400,460800,5e5,576e3,921600,1e6,1152e3,15e5,2e6,25e5,3e6,35e5,4e6],l=[{label:"RTU slave",value:"rtu-slave"},{label:"ASCII slave",value:"ascii-slave"},{label:"RTU master",value:"rtu-master"},{label:"ASCII master",value:"ascii-master"}],d=[{label:"1N - 1 stop bit, no parity",value:"1N"},{label:"1E - 1 stop bit, even parity",value:"1E"},{label:"1O - 1 stop bit, odd parity",value:"1O"},{label:"2N - 2 stop bits, no parity",value:"2N"}];function genRtuRequest(e){let{deviceId:t,funcCode:n,customPayload:r,address:a,quantity:c,value:u,subFunction:l,payload:d}=e,p="".concat(t.toString(16).padStart(2,"0"));if(r)p+="".concat(n.toString(16).padStart(2,"0"))+"".concat((0,o.uv)(d||""));else switch(p+="".concat(n.toString(16).padStart(2,"0")),n){case 1:case 2:case 3:case 4:p+="".concat((a||0).toString(16).padStart(4,"0"))+"".concat((c||0).toString(16).padStart(4,"0"));break;case 5:case 6:p+="".concat((a||0).toString(16).padStart(4,"0"))+"".concat((u||0).toString(16).padStart(4,"0"));break;case 7:case 11:case 12:case 17:break;case 8:p+="".concat((l||0).toString(16).padStart(2,"0"))+"".concat((0,o.uv)(d||""));break;case 15:p+="".concat((a||0).toString(16).padStart(4,"0"))+"".concat((c||0).toString(16).padStart(4,"0"))+"".concat(Math.ceil((d||"").length/4).toString(16).padStart(2,"0"))+"".concat((0,o.uv)(d||""));break;case 16:p+="".concat((a||0).toString(16).padStart(4,"0"))+"".concat((c||0).toString(16).padStart(4,"0"))+"".concat(Math.ceil((d||"").length/2).toString(16).padStart(2,"0"))+"".concat((0,o.uv)(d||""));break;default:p+="".concat((0,o.uv)(d||""))}let g=function(e){let t=65535;for(let n=0;n<e.length;n++)t=(s[(t^e[n])&255]^t>>8)&65535;return t<<8&65535|t>>8}(i.from(p,"hex")),f=g.toString(16).padStart(4,"0"),m=p;return[m+f,m,f]}function genTcpRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=t.toString(16).padStart(4,"0"),[r,a,o]=genRtuRequest(e),i=Math.ceil(a.length/2).toString(16).padStart(4,"0");return["".concat(n,"0000").concat(i).concat(a),o]}function genAsciiRequest(e){let[t,n]=genRtuRequest(e),r=n.toUpperCase().split("").map(e=>e.charCodeAt(0).toString(16).padStart(2,"0")).join(""),a=function(e){let t=0;for(let n=0;n<e.length;n++)t+=255&e[n];return(255^t)+1&255}(i.from(n,"hex")),o=a.toString(16).toUpperCase().split("").map(e=>e.charCodeAt(0).toString(16).padStart(2,"0")).join("");return["3A".concat(r).concat(o,"0D0A"),o]}async function sendModbusRequest(e,t,n,a,c){let s=n.trim().toLowerCase().split("\n").map(e=>e.trim()),u=[],l=0,d=0,p=0,report=()=>{c&&c("Requests sent: ".concat(l,"\nResponses: ").concat(d,"\nErrors: ").concat(p))};for(let n of s){if(n.startsWith("#")||0===n.length)continue;let c=(0,o.uv)(n),s={dataB64:i.from(c,"hex").toString("base64"),asIs:a,dst:t};l++,report();let g=await (0,r.ri)(e,"/api/modbus/send-request/",{method:"POST",body:JSON.stringify(s)}),f=await g.json();f.dataB64?d++:p++,report(),u.push({request:c,response:f.dataB64?i.from(f.dataB64,"base64").toString("hex"):"Error: ".concat(f.modbusErrorCode)})}let g="";for(let e of u)g+="> ".concat(e.request,"\n< ").concat(e.response,"\n");return c&&c(g),u}async function readOpcbRegisters(e,t,n,r,a){let o=[],i=r,c=n;for(;i>0;){let n=Math.min(i,125),r=await readRegistersRequest(e,t,c,n,a);o.push(...r),i-=n,c+=n}return o}async function readRegistersRequest(e,t,n,r,a){let[o,i,c]=genRtuRequest({deviceId:a,funcCode:"holding"===t?3:4,address:n,quantity:r}),s=(await sendModbusRequest(e,"VIR",i,!1))[0].response,u=[];for(let e=0;e<r;e++)u.push(parseInt(s.slice(6+4*e,10+4*e),16));return u}function parseModbusLogRecord(e,t){let[n,r,o,...i]=e.split(" "),[c,s]=n.split("-"),u=1e3*Number(c)+Number(s),l=(0,a.k6)(new Date(r)),d="<"!==o&&">"!==o?"#":o,p=i.join(" ");if("#"===d)return{id:u,raw:e,date:l,type:"#",content:{kind:"raw",payload:p}};let g=Array.from(p.match(/.{1,2}/g));return p.length%2!=0||"rtu"===t&&(p.length<8||p.length>254)||"ascii"===t&&(p.length<18||"3a"!==g[0]||"0d"!==g[g.length-2]||"0a"!==g[g.length-1])||"tcp"===t&&p.length<16?{id:u,raw:e,date:l,type:d,content:[{kind:"error",payload:g.join(" ")}]}:{id:u,raw:e,date:l,type:d,content:function(e,t,n){if("rtu"===t){let t=e.splice(-2).join(" ");return[Object.assign(getRtuNoCrcContent(e,n),{crc:t})]}if("ascii"===t){let t=parseInt(e.slice(3,5).map(e=>String.fromCharCode(parseInt(e,16))).join(""),16),n={kind:"correct",prefix:e[0],deviceId:e.slice(1,3).join(" "),functionCode:e.slice(3,5).join(" "),errorFunctionCode:t>=128,payload:e.slice(6,-4).join(" "),crc:e.slice(-4).join(" "),description:e.slice(1,-4).map(e=>String.fromCharCode(parseInt(e,16))).join("")};return[n]}if("rtu-no-crc"===t)return[getRtuNoCrcContent(e,n)];{let t=[];for(let n=0;n<100&&!(e.length<1);n++){let n=256*parseInt(e[4],16)+parseInt(e[5],16);if(e.length<6+n){t.push({kind:"error",payload:e.join(" ")});break}let r=e.splice(0,6+n),a=parseInt(r[7],16);t.push({kind:"correct",prefix:r.slice(0,6).join(" "),deviceId:r[6],functionCode:r[7],errorFunctionCode:a>=128,payload:r.slice(8).join(" ")})}return t}}(g,t,d)}}function getRtuNoCrcContent(e,t){let n=parseInt(e[1],16),r={kind:"correct",deviceId:e[0],functionCode:e[1],errorFunctionCode:n>=128,payload:e.slice(2).join(" ")};if(">"===t&&(3===n||4===n)){let t=parseInt(e.slice(2,4).join(""),16),a=parseInt(e.slice(4,6).join(""),16),o=3===n?"holding":"input";a>1?r.description="Read ".concat(o," ").concat(t,"-").concat(t+a-1):r.description="Read ".concat(o," ").concat(t)}if("<"===t&&(3===n||4===n)){let t=e.slice(3).join(""),n=t.match(/.{1,4}/g);if(n){let e=Array.from(n).map(e=>parseInt(e,16));r.description=e.join(", ")}}return r}}}]);