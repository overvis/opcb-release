(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[469],{5306:function(e,t,n){"use strict";function matches(e,t){let n=t||!0;return t=>"string"!=typeof t?n:e.test(t)?null:n}n.d(t,{w:function(){return matches}})},2968:function(e,t,n){"use strict";n.d(t,{Z:function(){return a}});var a=(0,n(4397).Z)("refresh","IconRefresh",[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]])},947:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/connections/modbus-rs485",function(){return n(1008)}])},9606:function(e,t,n){"use strict";n.d(t,{Z:function(){return LoadingSelect}});var a=n(966),s=n(1949),i=n(6886),o=n(7344),r=n(3624),d=n(7153),c=n(2968);function LoadingSelect(e){let t=(0,s.rZ)();return(0,a.jsx)(i.Ph,{...Object.fromEntries(Object.entries(e).filter(e=>{let[t]=e;return -1===["addValue","update","isLoading"].indexOf(t)})),searchable:!0,creatable:!0,withinPortal:!0,label:e.label,nothingFound:"Nothing found",getCreateLabel:e=>"+ Add interface: ".concat(e),onCreate:t=>(e.addValue(t),{value:t,label:t}),rightSectionWidth:50,rightSection:(0,a.jsxs)(o.Z,{spacing:"xs",position:"right",children:[e.isLoading?(0,a.jsx)(r.a,{size:14}):(0,a.jsx)(c.Z,{color:t.colors.blue[6],size:14,onClick:()=>{e.update()},style:{cursor:"pointer",pointerEvents:"all"}}),(0,a.jsx)(d.D,{size:"md",error:e.error})]}),styles:{rightSection:{pointerEvents:"none"}}})}},8575:function(e,t,n){"use strict";n.d(t,{$b:function(){return useRs485Settings},Cu:function(){return deleteRs485},Mn:function(){return updateRs485},tz:function(){return i},v4:function(){return createRs485}});var a=n(52),s=n(3738);function useRs485Settings(){return(0,a.tQ)("/api/rs485-connections/",s.ph)}async function updateRs485(e){let t=(0,a.bH)();await (0,a.ri)(t,"/api/rs485-connection/".concat(e.deviceName,"/update/"),{method:"POST",body:JSON.stringify(e),timeoutMs:3e4})}async function createRs485(e){let t=(0,a.bH)();await (0,a.ri)(t,"/api/rs485-connections/create/",{method:"POST",body:JSON.stringify(e),timeoutMs:3e4})}async function deleteRs485(e){let t=(0,a.bH)();return await (0,a.ri)(t,"/api/rs485-connection/".concat(e,"/remove/"),{method:"POST",body:JSON.stringify({}),timeoutMs:3e4}),(0,s.ph)(["/api/rs485-connections/",t])}let i={deviceName:"ttyUSB0",mode:"rtu-master",uidRange:"1-255",responseTimeoutMs:300,baudRate:9600,stopAndParityBits:"2N",broadcastIsEnabled:!0,isEnabled:!0,gatewayGeneratedExceptions:{pathUnavalableCode:1,targetDeviceFailedToRespondCode:2},portOpenRetryPeriod:5}},1008:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return Page}});var a=n(966),s=n(462),i=n(4418),o=n(9956),r=n(7344),d=n(3283),c=n(2484),l=n(3900),u=n(6435),m=n(8253),x=n(2094),p=n(5041),g=n(8482),h=n(6886),b=n(6078),v=n(8393),f=n(9724),j=n(5306),S=n(9561),y=n(7147),R=n(3174),Z=n(571),w=n(7452),N=n(7219),C=n(7723),P=n(4045),E=n(9606);function Rs485SettingsForm(e){let{initialValues:t,onSubmit:n,saving:i}=e,{classes:o}=(0,C.Z)(),r=(0,f.c)({initialValues:t,validate:{uidRange:(0,j.w)(/^(\d+-\d+,)*\d+-\d+$/,'Invalid range, use format "1-10,30-40"'),responseTimeoutMs:(0,S.m)({min:1,max:6e4},"Must be between 1 and 60000"),gatewayGeneratedExceptions:{pathUnavalableCode:(0,S.m)({min:1,max:255},"Must be between 1 and 255"),targetDeviceFailedToRespondCode:(0,S.m)({min:1,max:255},"Must be between 1 and 255")},portOpenRetryPeriod:(0,S.m)({min:1,max:600},"Must be between 1 and 600"),deviceName:(0,j.w)(/^[a-zA-Z0-9_-]{2,20}$/,"Invalid device name, can contain only letters and numbers, 20 cahracters max")}}),[c,u]=(0,l.useState)(!1),[m,x,M,O]=(0,Z.jz)([],r.values.usedTtys||[]),T="create"===r.values.formMode;T&&""===r.values.deviceName&&m.length>0&&r.setFieldValue("deviceName",m[0].value);let z=(0,N.uA)(r,"update"===r.values.formMode?o.dirtyInput:void 0);return(0,a.jsx)("form",{onSubmit:r.onSubmit(async e=>{let t=await n(e);t&&r.resetDirty()}),children:(0,a.jsxs)(s.K,{children:["create"===r.values.formMode?(0,a.jsx)(E.Z,{label:"Device (TTY):",data:m,isLoading:x,addValue:e=>{O(t=>t.concat(e))},update:M,...z("deviceName"),required:!0}):(0,a.jsx)(p.r,{label:"Enabled",...z("isEnabled","checkbox")}),(0,a.jsx)(g.U,{in:r.values.isEnabled,children:(0,a.jsxs)(s.K,{children:[(0,a.jsx)(h.Ph,{withinPortal:!0,label:"Mode:",data:Z.EH,...z("mode")}),("rtu-master"===r.values.mode||"ascii-master"===r.values.mode||"ipka-master"===r.values.mode)&&(0,a.jsx)(b.o,{label:"Device ID range:",...z("uidRange")}),(0,a.jsx)(h.Ph,{withinPortal:!0,label:"Baud rate:",data:Z._.map(e=>({value:e.toString(),label:e.toString()})),...z("baudRate"),value:r.values.baudRate.toString(),onChange:e=>{r.setFieldValue("baudRate",parseInt(e||"9600",10))}}),(0,a.jsx)(h.Ph,{withinPortal:!0,label:"Stop and parity bits:",data:Z.dH,...z("stopAndParityBits")}),c?(0,a.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,a.jsx)(y.Z,{size:14}),size:"xs",onClick:()=>u(!1),children:"Hide advanced settings"}):(0,a.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,a.jsx)(R.Z,{size:14}),size:"xs",onClick:()=>u(!0),children:"Show advanced settings"}),(0,a.jsx)(g.U,{in:c,transitionDuration:100,children:(0,a.jsxs)(s.K,{children:[(0,a.jsx)(v.Y,{label:"Response timeout (ms):",required:!0,...z("responseTimeoutMs")}),(0,a.jsx)(v.Y,{label:"Retry period on port open failure (s):",required:!0,...z("portOpenRetryPeriod")}),(0,a.jsx)(P.Z,{label:"Path unavailable error code (HEX):",hex:!0,required:!0,...z("gatewayGeneratedExceptions.pathUnavalableCode")}),(0,a.jsx)(P.Z,{label:"Target device failed to respond error code (HEX):",hex:!0,required:!0,...z("gatewayGeneratedExceptions.targetDeviceFailedToRespondCode")})]})})]})}),(0,a.jsx)(w.Z,{type:"submit",inProgress:i,children:"Save"})]})})}var M=n(9977),O=n(868),T=n(3600),z=n(4621),k=n(7816),D=n(9804),I=n(8575),B=n(5451),V=n(1921),_=n(477),A=n(169),F=n(3610),L=n(829);function Rs485Status(e){let{settings:t,status:n,mutate:i,onSettingsUpdate:o}=e,[d,c]=(0,l.useState)(!1);return(0,a.jsx)(A.Z,{name:t.deviceName,icon:(null==n?void 0:n.info.status)==="connected"?(0,a.jsx)(T.Z,{}):(0,a.jsx)(z.Z,{}),status:(null==n?void 0:n.info.status)==="connected"?"connected":(null==n?void 0:n.info.status)==="attempting"?"disconnected":"disabled",settings:{title:"RS-485 port settings: ".concat(t.deviceName),form:Rs485SettingsForm,useSettings:()=>({data:{...t,formMode:"update"},error:void 0,isValidating:!1,isLoading:!1,mutate:async()=>void 0}),save:I.Mn,onSettingsUpdate:o},addElRight:(0,a.jsx)(L.Z,{title:"Delete conection",description:'Are you sure you want to delete the connection "'.concat(t.deviceName,'"?'),buttonText:"Delete",children:(0,a.jsx)(M.A,{color:"red",onClick:()=>{(0,N.Mx)(()=>i((0,I.Cu)(t.deviceName),{optimisticData:e=>e.filter(e=>e.deviceName!==t.deviceName)}))},children:(0,a.jsx)(k.Z,{size:18})})}),children:n?(0,a.jsxs)(s.K,{spacing:0,children:["connected"===n.info.status?(0,a.jsx)(ConnectedStatus,{mode:n.mode,info:n.info}):"attempting"===n.info.status?(0,a.jsx)(AttemptingStatus,{mode:n.mode,info:n.info}):(0,a.jsx)(B.Z,{text:"Port disabled in settings."}),(0,a.jsx)(DebugZone,{debugShown:d,setDebugShown:c,settings:t,status:n})]}):(0,a.jsxs)(r.Z,{p:"xs",spacing:"xs",children:[(0,a.jsx)(O.O,{width:100,height:70,radius:"sm"}),(0,a.jsx)(O.O,{width:100,height:70,radius:"sm"}),(0,a.jsx)(O.O,{width:200,height:70,radius:"sm"})]})})}function DebugZone(e){let{debugShown:t,setDebugShown:n,settings:i,status:o}=e;return(0,a.jsxs)(s.K,{bg:"gray.0",sx:e=>({borderTop:"1px solid ".concat(e.colors.gray[3])}),p:2,spacing:0,children:[(0,a.jsx)(r.Z,{children:t?(0,a.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,a.jsx)(y.Z,{size:14}),size:"xs",onClick:()=>n(!1),children:"Hide debug tools"}):(0,a.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,a.jsx)(R.Z,{size:14}),size:"xs",onClick:()=>n(!0),children:"Show debug tools"})}),(0,a.jsx)(g.U,{in:t,transitionDuration:100,children:(0,a.jsx)(r.Z,{mih:100,w:"100%",children:t&&(0,a.jsx)(V.Z,{dst:"RSO-".concat(i.deviceName),mode:"rtu-master"===o.mode.protocol||"rtu-slave"===o.mode.protocol?"rtu":"ascii",isMaster:"rtu-master"===o.mode.protocol||"ascii-master"===o.mode.protocol||"ipka-master"===o.mode.protocol})})})]})}function AttemptingStatus(e){let{info:t,mode:n}=e;return(0,a.jsxs)(r.Z,{align:"start",p:"sm",children:[(0,a.jsx)(F.Z,{name:"Connecting as",nameColor:"red",mainVal:displayProtocolName(n),subVal:t.lastConnectedOn&&(0,a.jsxs)(a.Fragment,{children:["Last successful connection was on ",(0,a.jsx)("br",{}),(0,D.o0)(t.lastConnectedOn)]})}),(0,a.jsx)(F.Z,{name:"Error",nameColor:"red",mainVal:t.lastError||"-",subVal:"Attempt: ".concat(t.attemptsNum)})]})}function displayProtocolName(e){var t;return(null===(t=Z.EH.find(t=>t.value===e.protocol))||void 0===t?void 0:t.label)||"unknown"}function ConnectedStatus(e){let{info:t,mode:n}=e;return(0,a.jsxs)(r.Z,{align:"start",p:"sm",children:[(0,a.jsx)(F.Z,{name:"Connected as",nameColor:"green",mainVal:displayProtocolName(n),subVal:(0,D.o0)(t.connectedOn,!0)}),"routes"in n?(0,a.jsx)(F.Z,{name:"Routes",mainVal:n.routes}):void 0,(0,a.jsx)(_.Z,{bytes:t.rxtx.rxTotalBytes,lastBytesSinceSec:t.rxtx.rxLastBytesSinceSec,speed:t.rxtx.rxSpeedBytesPerSec,oneline:!1}),(0,a.jsx)(_.Z,{bytes:t.rxtx.txTotalBytes,lastBytesSinceSec:t.rxtx.txLastBytesSinceSec,speed:t.rxtx.txSpeedBytesPerSec,tx:!0,oneline:!1})]})}var H=n(928);function Page(){var e;let t=(0,I.$b)(),n=(0,H.RW)(),[p,g]=(0,l.useState)(!1),h=(null===(e=t.data)||void 0===e?void 0:e.length)?t.data.map(e=>e.deviceName):[];return t.data&&n.data?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(m.Z,{title:"Add RS-485 connection",onSettingsUpdate:()=>{t.mutate()},form:Rs485SettingsForm,useSettings:()=>({data:{formMode:"create",deviceName:"",isEnabled:!0,mode:"rtu-master",uidRange:"1-255",responseTimeoutMs:300,baudRate:9600,stopAndParityBits:"2N",broadcastIsEnabled:!1,gatewayGeneratedExceptions:{pathUnavalableCode:10,targetDeviceFailedToRespondCode:11},portOpenRetryPeriod:5,usedTtys:h},error:void 0,isValidating:!1,isLoading:!1,mutate:async()=>void 0}),save:I.v4,opened:p,setOpened:g}),(0,a.jsx)(u.Z,{pageId:"modbus-rs485",title:"Modbus Over RS-485",children:(0,a.jsxs)(s.K,{children:[t.data.length>0?t.data.map(e=>(0,a.jsx)(Rs485Status,{settings:e,status:n.data&&n.data[e.deviceName],onSettingsUpdate:()=>{t.mutate()},mutate:t.mutate},e.deviceName)):(0,a.jsx)(i.X,{p:"lg",bg:"gray.1",withBorder:!0,children:(0,a.jsx)(o.x,{ta:"center",fz:"sm",children:"No RS-485 connections created."})}),(0,a.jsx)(r.Z,{children:(0,a.jsx)(d.z,{onClick:()=>{g(!0)},leftIcon:(0,a.jsx)(c.Z,{}),children:"Add RS-485 connection"})})]})})]}):(0,a.jsx)(x.Z,{pageTitle:"Modbus Over RS-485",contentIsLoading:!0})}}},function(e){e.O(0,[217,666,161,427,420,467,94,593,633,774,888,179],function(){return e(e.s=947)}),_N_E=e.O()}]);