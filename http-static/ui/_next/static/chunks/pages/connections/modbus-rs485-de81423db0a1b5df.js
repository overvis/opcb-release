(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[469],{5306:function(e,t,n){"use strict";function matches(e,t){let n=t||!0;return t=>"string"!=typeof t?n:e.test(t)?null:n}n.d(t,{w:function(){return matches}})},2968:function(e,t,n){"use strict";n.d(t,{Z:function(){return a}});var a=(0,n(4397).Z)("refresh","IconRefresh",[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]])},947:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/connections/modbus-rs485",function(){return n(8654)}])},9606:function(e,t,n){"use strict";n.d(t,{Z:function(){return LoadingSelect}});var a=n(966),s=n(1949),i=n(6886),o=n(7344),r=n(3624),d=n(7153),c=n(2968);function LoadingSelect(e){let t=(0,s.rZ)();return(0,a.jsx)(i.Ph,{...Object.fromEntries(Object.entries(e).filter(e=>{let[t]=e;return -1===["addValue","update","isLoading"].indexOf(t)})),searchable:!0,creatable:!0,withinPortal:!0,label:e.label,nothingFound:"Nothing found",getCreateLabel:e=>"+ Add interface: ".concat(e),onCreate:t=>(e.addValue(t),{value:t,label:t}),rightSectionWidth:50,rightSection:(0,a.jsxs)(o.Z,{spacing:"xs",position:"right",children:[e.isLoading?(0,a.jsx)(r.a,{size:14}):(0,a.jsx)(c.Z,{color:t.colors.blue[6],size:14,onClick:()=>{e.update()},style:{cursor:"pointer",pointerEvents:"all"}}),(0,a.jsx)(d.D,{size:"md",error:e.error})]}),styles:{rightSection:{pointerEvents:"none"}}})}},8575:function(e,t,n){"use strict";n.d(t,{$b:function(){return useRs485Settings},Cu:function(){return deleteRs485},Mn:function(){return updateRs485},tz:function(){return i},v4:function(){return createRs485}});var a=n(52),s=n(3738);function useRs485Settings(){return(0,a.tQ)("/api/rs485-connections/",s.ph)}async function updateRs485(e){let t=(0,a.bH)();await (0,a.ri)(t,"/api/rs485-connection/".concat(e.deviceName,"/update/"),{method:"POST",body:JSON.stringify(e),timeoutMs:3e4})}async function createRs485(e){let t=(0,a.bH)();await (0,a.ri)(t,"/api/rs485-connections/create/",{method:"POST",body:JSON.stringify(e),timeoutMs:3e4})}async function deleteRs485(e){let t=(0,a.bH)();return await (0,a.ri)(t,"/api/rs485-connection/".concat(e,"/remove/"),{method:"POST",body:JSON.stringify({}),timeoutMs:3e4}),(0,s.ph)(["/api/rs485-connections/",t])}let i={deviceName:"ttyUSB0",mode:"rtu-master",uidRange:"1-255",responseTimeoutMs:300,baudRate:9600,stopAndParityBits:"2N",broadcastIsEnabled:!0,isEnabled:!0,gatewayGeneratedExceptions:{pathUnavalableCode:1,targetDeviceFailedToRespondCode:2},portOpenRetryPeriod:5}},8654:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return Page}});var a=n(966),s=n(462),i=n(4418),o=n(9956),r=n(7344),d=n(3283),c=n(2484),l=n(3900),u=n(6435),m=n(8253),x=n(2094),p=n(5041),h=n(8482),g=n(6886),v=n(6078),b=n(8393),f=n(9724),j=n(5306),S=n(9561),y=n(7147),R=n(3174),Z=n(9342),w=n(52);async function fetchTtys(e){let[t,n]=e;return(await (0,w.ri)(n,t)).json()}var C=n(7452),N=n(7219),P=n(7723),E=n(4045),T=n(9606);function Rs485SettingsForm(e){let{initialValues:t,onSubmit:n,saving:i}=e,{classes:o}=(0,P.Z)(),r=(0,f.c)({initialValues:t,validate:{uidRange:(0,j.w)(/^(\d+-\d+,)*\d+-\d+$/,'Invalid range, use format "1-10,30-40"'),responseTimeoutMs:(0,S.m)({min:1,max:6e4},"Must be between 1 and 60000"),gatewayGeneratedExceptions:{pathUnavalableCode:(0,S.m)({min:1,max:255},"Must be between 1 and 255"),targetDeviceFailedToRespondCode:(0,S.m)({min:1,max:255},"Must be between 1 and 255")},portOpenRetryPeriod:(0,S.m)({min:1,max:600},"Must be between 1 and 600"),deviceName:(0,j.w)(/^[a-zA-Z0-9_-]{2,20}$/,"Invalid device name, can contain only letters and numbers, 20 cahracters max")}}),[c,u]=(0,l.useState)(!1),[m,x,M,O]=function(e,t){let[n,a]=(0,l.useState)(e),{data:s,mutate:i,isLoading:o}=function(){let e=(0,w.tQ)("/api/list/ttys/",fetchTtys);return{data:e.data,isLoading:e.isLoading||e.isValidating,mutate:t=>{t?e.mutate(t,{revalidate:!1}):e.mutate()}}}(),r=[];return[r=(r=r.concat(...s?s.filter(e=>!t.includes(e)).map(e=>({value:e,label:e})):[])).concat(...n.map(e=>({value:e,label:e}))),o,i,a]}([],r.values.usedTtys||[]),z="create"===r.values.formMode;z&&""===r.values.deviceName&&m.length>0&&r.setFieldValue("deviceName",m[0].value);let I=(0,N.u)(r,"update"===r.values.formMode?o.dirtyInput:void 0);return(0,a.jsx)("form",{onSubmit:r.onSubmit(async e=>{let t=await n(e);t&&r.resetDirty()}),children:(0,a.jsxs)(s.K,{children:["create"===r.values.formMode?(0,a.jsx)(T.Z,{label:"Device (TTY):",data:m,isLoading:x,addValue:e=>{O(t=>t.concat(e))},update:M,...I("deviceName"),required:!0}):(0,a.jsx)(p.r,{label:"Enabled",...I("isEnabled","checkbox")}),(0,a.jsx)(h.U,{in:r.values.isEnabled,children:(0,a.jsxs)(s.K,{children:[(0,a.jsx)(g.Ph,{withinPortal:!0,label:"Mode:",data:Z.EH,...I("mode")}),("rtu-master"===r.values.mode||"ascii-master"===r.values.mode)&&(0,a.jsx)(v.o,{label:"Device ID range:",...I("uidRange")}),(0,a.jsx)(g.Ph,{withinPortal:!0,label:"Baud rate:",data:Z._.map(e=>({value:e.toString(),label:e.toString()})),...I("baudRate"),value:r.values.baudRate.toString(),onChange:e=>{r.setFieldValue("baudRate",parseInt(e||"9600",10))}}),(0,a.jsx)(g.Ph,{withinPortal:!0,label:"Stop and parity bits:",data:Z.J4,...I("stopAndParityBits")}),c?(0,a.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,a.jsx)(y.Z,{size:14}),size:"xs",onClick:()=>u(!1),children:"Hide advanced settings"}):(0,a.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,a.jsx)(R.Z,{size:14}),size:"xs",onClick:()=>u(!0),children:"Show advanced settings"}),(0,a.jsx)(h.U,{in:c,transitionDuration:100,children:(0,a.jsxs)(s.K,{children:[(0,a.jsx)(b.Y,{label:"Response timeout (ms):",required:!0,...I("responseTimeoutMs")}),(0,a.jsx)(b.Y,{label:"Retry period on port open failure (s):",required:!0,...I("portOpenRetryPeriod")}),(0,a.jsx)(E.Z,{label:"Path unavailable error code (HEX):",hex:!0,required:!0,...I("gatewayGeneratedExceptions.pathUnavalableCode")}),(0,a.jsx)(E.Z,{label:"Target device failed to respond error code (HEX):",hex:!0,required:!0,...I("gatewayGeneratedExceptions.targetDeviceFailedToRespondCode")})]})})]})}),(0,a.jsx)(C.Z,{type:"submit",inProgress:i,children:"Save"})]})})}var M=n(9977),O=n(868),z=n(3600),I=n(4621),V=n(7816),k=n(9804),A=n(8575),B=n(5451),D=n(1921),L=n(477),_=n(5465),F=n(3610),U=n(829);function Rs485Status(e){let{settings:t,status:n,mutate:i,onSettingsUpdate:o}=e,[c,u]=(0,l.useState)(!1);return(0,a.jsx)(_.Z,{name:t.deviceName,icon:(null==n?void 0:n.info.status)==="connected"?(0,a.jsx)(z.Z,{}):(0,a.jsx)(I.Z,{}),status:(null==n?void 0:n.info.status)==="connected"?"connected":(null==n?void 0:n.info.status)==="attempting"?"disconnected":"disabled",settings:{title:"RS-485 port settings: ".concat(t.deviceName),form:Rs485SettingsForm,useSettings:()=>({data:{...t,formMode:"update"},error:void 0,isValidating:!1,isLoading:!1,mutate:async()=>void 0}),save:A.Mn,onSettingsUpdate:o},addElRight:(0,a.jsx)(U.Z,{title:"Delete conection",description:'Are you sure you want to delete the connection "'.concat(t.deviceName,'"?'),buttonText:"Delete",children:(0,a.jsx)(M.A,{color:"red",onClick:()=>{(0,N.M)(()=>i((0,A.Cu)(t.deviceName),{optimisticData:e=>e.filter(e=>e.deviceName!==t.deviceName)}))},children:(0,a.jsx)(V.Z,{size:18})})}),children:n?(0,a.jsxs)(s.K,{spacing:0,children:["connected"===n.info.status?(0,a.jsxs)(r.Z,{align:"start",p:"sm",children:[(0,a.jsx)(F.Z,{name:"Connected as",nameColor:"green",mainVal:(n.mode.isAscii?"ASCII":"RTU")+("slave"===n.mode.status?" slave":" master"),subVal:(0,k.o0)(n.info.connectedOn,!0)}),"master"===n.mode.status&&(0,a.jsx)(F.Z,{name:"Routes",mainVal:n.mode.routes}),(0,a.jsx)(L.Z,{bytes:n.info.rxtx.rxTotalBytes,lastBytesSinceSec:n.info.rxtx.rxLastBytesSinceSec,speed:n.info.rxtx.rxSpeedBytesPerSec,oneline:!1}),(0,a.jsx)(L.Z,{bytes:n.info.rxtx.txTotalBytes,lastBytesSinceSec:n.info.rxtx.txLastBytesSinceSec,speed:n.info.rxtx.txSpeedBytesPerSec,tx:!0,oneline:!1})]}):"attempting"===n.info.status?(0,a.jsxs)(r.Z,{align:"start",p:"sm",children:[(0,a.jsx)(F.Z,{name:"Connecting as",nameColor:"red",mainVal:(n.mode.isAscii?"ASCII":"RTU")+("slave"===n.mode.status?" slave":" master"),subVal:n.info.lastConnectedOn&&(0,a.jsxs)(a.Fragment,{children:["Last successful connection was on ",(0,a.jsx)("br",{}),(0,k.o0)(n.info.lastConnectedOn)]})}),(0,a.jsx)(F.Z,{name:"Error",nameColor:"red",mainVal:n.info.lastError||"-",subVal:"Attempt: ".concat(n.info.attemptsNum)})]}):(0,a.jsx)(B.Z,{text:"Port disabled in settings."}),"connected"===n.info.status&&(0,a.jsxs)(s.K,{bg:"gray.0",sx:e=>({borderTop:"1px solid ".concat(e.colors.gray[3])}),p:2,spacing:0,children:[(0,a.jsx)(r.Z,{children:c?(0,a.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,a.jsx)(y.Z,{size:14}),size:"xs",onClick:()=>u(!1),children:"Hide debug tools"}):(0,a.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,a.jsx)(R.Z,{size:14}),size:"xs",onClick:()=>u(!0),children:"Show debug tools"})}),(0,a.jsx)(h.U,{in:c,transitionDuration:100,children:(0,a.jsx)(r.Z,{mih:100,w:"100%",children:c&&(0,a.jsx)(D.Z,{dst:"RSO-".concat(t.deviceName),mode:"rtu-master"===t.mode||"rtu-slave"===t.mode?"rtu":"ascii",isMaster:"rtu-master"===t.mode||"ascii-master"===t.mode})})})]})]}):(0,a.jsxs)(r.Z,{p:"xs",spacing:"xs",children:[(0,a.jsx)(O.O,{width:100,height:70,radius:"sm"}),(0,a.jsx)(O.O,{width:100,height:70,radius:"sm"}),(0,a.jsx)(O.O,{width:200,height:70,radius:"sm"})]})})}var H=n(928);function Page(){var e;let t=(0,A.$b)(),n=(0,H.RW)(),[p,h]=(0,l.useState)(!1),g=(null===(e=t.data)||void 0===e?void 0:e.length)?t.data.map(e=>e.deviceName):[];return t.data&&n.data?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(m.Z,{title:"Add RS-485 connection",onSettingsUpdate:()=>{t.mutate()},form:Rs485SettingsForm,useSettings:()=>({data:{formMode:"create",deviceName:"",isEnabled:!0,mode:"rtu-master",uidRange:"1-255",responseTimeoutMs:300,baudRate:9600,stopAndParityBits:"2N",broadcastIsEnabled:!1,gatewayGeneratedExceptions:{pathUnavalableCode:10,targetDeviceFailedToRespondCode:11},portOpenRetryPeriod:5,usedTtys:g},error:void 0,isValidating:!1,isLoading:!1,mutate:async()=>void 0}),save:A.v4,opened:p,setOpened:h}),(0,a.jsx)(u.Z,{pageId:"modbus-rs485",title:"Modbus Over RS-485",children:(0,a.jsxs)(s.K,{children:[t.data.length>0?t.data.map(e=>(0,a.jsx)(Rs485Status,{settings:e,status:n.data&&n.data[e.deviceName],onSettingsUpdate:()=>{t.mutate()},mutate:t.mutate},e.deviceName)):(0,a.jsx)(i.X,{p:"lg",bg:"gray.1",withBorder:!0,children:(0,a.jsx)(o.x,{ta:"center",fz:"sm",children:"No RS-485 connections created."})}),(0,a.jsx)(r.Z,{children:(0,a.jsx)(d.z,{onClick:()=>{h(!0)},leftIcon:(0,a.jsx)(c.Z,{}),children:"Add RS-485 connection"})})]})})]}):(0,a.jsx)(x.Z,{pageTitle:"Modbus Over RS-485",contentIsLoading:!0})}}},function(e){e.O(0,[217,666,388,924,27,401,94,874,89,774,888,179],function(){return e(e.s=947)}),_N_E=e.O()}]);