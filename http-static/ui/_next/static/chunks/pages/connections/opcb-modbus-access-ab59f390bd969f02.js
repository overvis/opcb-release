(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[741],{392:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/connections/opcb-modbus-access",function(){return s(9597)}])},9597:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return Page}});var r=s(966),n=s(462),i=s(7344),a=s(8769),c=s(4339),o=s(6435),l=s(5451),d=s(3283),u=s(8482),h=s(7147),x=s(3174),m=s(3900),f=s(4101);function ModbusLogWithBtn(e){let{mode:t,streamName:s}=e,[a,c]=(0,m.useState)(!1);return(0,r.jsxs)(n.K,{bg:"gray.0",sx:e=>({borderTop:"1px solid ".concat(e.colors.gray[3])}),p:2,spacing:0,children:[(0,r.jsx)(i.Z,{children:a?(0,r.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,r.jsx)(h.Z,{size:14}),size:"xs",onClick:()=>c(!1),children:"Hide log"}):(0,r.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,r.jsx)(x.Z,{size:14}),size:"xs",onClick:()=>c(!0),children:"Show log"})}),(0,r.jsx)(u.U,{in:a,transitionDuration:100,children:(0,r.jsx)(i.Z,{mih:100,grow:!0,p:"xs",children:a&&(0,r.jsx)(f.Z,{mode:t,streamName:s})})})]})}var g=s(2094),p=s(5041),b=s(8393),j=s(9724),v=s(9561),y=s(7452),w=s(7219),P=s(7723);function OpcbModbusSettingsForm(e){let{initialValues:t,onSubmit:s,saving:i}=e,a=(0,j.c)({initialValues:t,validate:{uid:(0,v.m)({min:1,max:255},"Must be between 1 and 255")}}),{classes:c}=(0,P.Z)(),o=(0,w.uA)(a,c.dirtyInput);return(0,r.jsx)("form",{onSubmit:a.onSubmit(async e=>{let t=await s(e);t&&a.resetDirty()}),children:(0,r.jsxs)(n.K,{children:[(0,r.jsx)(p.r,{label:"Enabled",...o("isEnabled","checkbox")}),(0,r.jsx)(b.Y,{label:"OPCB Modbus ID:",mih:1,max:255,required:!0,...o("uid")}),(0,r.jsx)(y.Z,{type:"submit",inProgress:i,children:"Save"})]})})}var D=s(4972),S=s(3738),Z=s(4224),E=s(8078),M=s(9956),k=s(1431),I=s(9342);function OpcbParametersTable(e){let{parameters:t,values:s,paramsInfoShownMap:n,handleParamsInfoToggle:i,uid:a,token:c}=e;return(0,r.jsxs)(Z.i,{w:"100%",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{style:{width:"120px"},children:"Address"}),(0,r.jsx)("th",{children:"Name"}),(0,r.jsx)("th",{style:{width:"170px"},children:"Current Value"})]})}),(0,r.jsx)("tbody",{children:Array.from(t.entries()).map(e=>{let[t,o]=e;return(0,r.jsx)(C,{parameter:o,infoShown:n["".concat(o.group).concat(o.registers[0])],handleParamsInfoToggle:i,uid:a,token:c,value:s["".concat(o.source,":").concat(o.redisPath)]},t)})})]})}let C=(0,m.memo)(function(e){let{parameter:t,infoShown:s,handleParamsInfoToggle:n,value:a,uid:c,token:o}=e;return(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:(0,r.jsx)(RegistersRange,{registers:t.registers,type:t.type})}),(0,r.jsxs)("td",{children:[(0,r.jsxs)(E.k,{children:[(0,r.jsx)(M.x,{mr:5,span:!0,c:"gray.8",children:t.name}),(0,r.jsx)(k.k,{c:"blue",w:17,pt:2,onClick:()=>n("".concat(t.group).concat(t.registers[0])),children:!t.hiddenDescription&&(s?(0,r.jsx)(h.Z,{size:14}):(0,r.jsx)(x.Z,{size:14}))})]}),!t.hiddenDescription&&(0,r.jsx)(u.U,{in:s,transitionDuration:100,children:(0,r.jsx)(i.Z,{mih:50,children:s&&(0,r.jsx)(ParameterInfo,{parameter:t,uid:c,token:o})})})]}),(0,r.jsx)("td",{children:(0,r.jsx)(M.x,{c:"green",children:a||"-"})})]})},(e,t)=>e.infoShown===t.infoShown&&e.value===t.value);function ParameterInfo(e){let{parameter:t,token:s,uid:a}=e,[c,o]=(0,m.useState)([]);return(0,m.useEffect)(()=>{let fetchData=async()=>{try{o([...(await (0,I.$b)(s,t.type,t.registers[0],t.registers.length,a)).map(e=>e.toFixed(0))])}catch(e){console.error(e)}},e=(0,S.As)(fetchData,5e3);return()=>{e()}},[]),(0,r.jsxs)(n.K,{spacing:2,children:[(0,r.jsx)(M.x,{c:"dimmed",children:t.description}),(0,r.jsx)(E.k,{wrap:"wrap",gap:2,children:t.registers.map((e,t)=>(0,r.jsxs)(i.Z,{spacing:4,mr:5,children:[(0,r.jsx)(M.x,{c:"gray.7",children:"".concat(e,":")}),(0,r.jsx)(M.x,{c:"green",children:c[t]||"-"})]},t))})]})}function RegistersRange(e){let{registers:t,type:s}=e;s=s[0];let n=1===t.length?"".concat(t[0]):"".concat(Math.min(...t),"-").concat(Math.max(...t));return(0,r.jsxs)(i.Z,{spacing:4,children:[(0,r.jsx)(M.x,{children:n}),(0,r.jsx)(M.x,{c:"dimmed",children:s})]})}function OpcbParamsGroupsAccordion(e){let{parameters:t,token:s,uid:n}=e,[i,a]=(0,m.useState)([]),[c,o]=(0,m.useState)({}),[l,d]=(0,m.useState)(t.reduce((e,t)=>(e["".concat(t.group).concat(t.registers[0])]=!1,e),{})),u=function(e){var t,s;let r=new Map;for(let s of e){let e=s.group;r.has(e)||r.set(e,[]),null===(t=r.get(e))||void 0===t||t.push(s)}for(let e of Array.from(r.keys()))r.set(e,(null===(s=r.get(e))||void 0===s?void 0:s.sort((e,t)=>e.registers[0]-t.registers[0]))||[]);return r}(t.sort((e,t)=>e.group.localeCompare(t.group)));(0,m.useEffect)(()=>{let fetchData=async()=>{if(!i.length)return;let e=[],t=[],r=new Map;for(let s of i){let n=u.get(s);if(!n)continue;let i=0;for(let s of n)if("modbus"===s.source){var a;let e=s.registers[0],t=(null===(a=r.get(e-i))||void 0===a?void 0:a.quantity)||0,n=t+1;r.set(e-i,{quantity:n,type:s.type}),i=n}else{if(!s.redisPath)continue;"config"===s.source?e.push(s.redisPath):t.push(s.redisPath)}}let c={};if(e.length){let t=await (0,S.wv)(s,e);for(let e in t)c["config:".concat(e)]=t[e]}if(t.length){let e=await (0,S.UK)(s,t);for(let t in e)c["state:".concat(t)]=e[t]}if(r.size)for(let[e,t]of Array.from(r.entries())){let r=await (0,I.$b)(s,t.type,e,t.quantity,n);for(let[t,s]of Array.from(r.entries()))c["modbus:".concat(e+t)]=s.toFixed(0)}o(c)},e=(0,S.As)(fetchData,5e3);return()=>{e()}},[i]);let handleParamsInfoToggle=e=>{let t={...l};for(let s in t[e]=!t[e],t)s!==e&&(t[s]=!1);d(t)};return(0,r.jsx)(D.U,{radius:"xs",transitionDuration:100,multiple:!0,styles:{control:{"&[data-active]":{backgroundColor:"#f8f9fa"}}},onChange:e=>{a([...e])},children:Array.from(u.entries()).map(e=>{let[t,a]=e;return(0,r.jsxs)(D.U.Item,{value:t,children:[(0,r.jsx)(D.U.Control,{c:"blue",children:t}),(0,r.jsx)(D.U.Panel,{p:0,children:i.includes(t)&&(0,r.jsx)(OpcbParametersTable,{parameters:a,values:c,paramsInfoShownMap:l,handleParamsInfoToggle:handleParamsInfoToggle,uid:n,token:s})})]},t)})})}var O=s(169),A=s(3610),_=s(52);async function settingsFetcher(e){let[t,s]=e,r=await (0,S.wv)(s,["virtualDevice:isEnabled","virtualDevice:uid"]);return{isEnabled:"true"===r["virtualDevice:isEnabled"],uid:parseInt(r["virtualDevice:uid"],10)}}async function saveSettings(e){let t={"virtualDevice:isEnabled":e.isEnabled?"true":"false","virtualDevice:uid":e.uid.toString()};return(0,S.NC)(t)}async function fetcher(e){let[t,s]=e,r=await (0,S.UK)(s,["virtualDevice:uid","virtualDevice:isEnabled"]);return{uid:Number(r["virtualDevice:uid"]),isEnabled:"true"===r["virtualDevice:isEnabled"]}}async function modbusParamsFetcher(e){let[t,s]=e,r=await (0,S.UK)(s,["virtualDevice:modbusParameters"]);return JSON.parse(r["virtualDevice:modbusParameters"])}function Page(){let e=function(){let e=(0,_.tQ)("modbus-opcb",settingsFetcher);return{...e}}(),t=(0,_.tQ)("opcbModbus-status",fetcher,{refreshInterval:1e3}),s=(0,_.tQ)("opcbModbus-params",modbusParamsFetcher),{token:d}=(0,_.pk)(),u=e.data,h=t.data,x=s.data;return u&&h&&x&&d?(0,r.jsx)(o.Z,{pageId:"opcb-modbus-access",title:"OPCB Modbus Access",children:(0,r.jsx)(n.K,{children:(0,r.jsx)(O.Z,{name:"OPCB Modbus Access",icon:h.isEnabled?(0,r.jsx)(a.Z,{}):(0,r.jsx)(c.Z,{}),status:h.isEnabled?"connected":"disabled",settings:{title:"OPCB Modbus settings",form:OpcbModbusSettingsForm,useSettings:()=>({data:{...u,formMode:"update"},error:void 0,isValidating:!1,isLoading:!1,mutate:async()=>void 0}),save:saveSettings,onSettingsUpdate:()=>{e.mutate()}},children:h.isEnabled?(0,r.jsxs)(n.K,{spacing:"sm",children:[(0,r.jsx)(i.Z,{align:"start",p:"sm",children:(0,r.jsx)(A.Z,{name:"Modbus ID",mainVal:h.uid})}),(0,r.jsx)(OpcbParamsGroupsAccordion,{parameters:x,token:d,uid:h.uid}),(0,r.jsx)(ModbusLogWithBtn,{mode:"rtu-no-crc",streamName:"VIR"})]}):(0,r.jsx)(l.Z,{icon:(0,r.jsx)(c.Z,{}),text:"OPCB Modbus is disabled in settings."})})})}):(0,r.jsx)(g.Z,{pageTitle:"Modbus TCP Server",contentIsLoading:!0})}}},function(e){e.O(0,[217,666,161,497,351,895,79,94,811,508,774,888,179],function(){return e(e.s=392)}),_N_E=e.O()}]);