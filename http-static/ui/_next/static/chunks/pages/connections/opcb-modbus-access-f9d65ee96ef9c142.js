(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[741],{264:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/connections/opcb-modbus-access",function(){return n(1399)}])},1399:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return H}});var i=n(6521),s=n(5388),r=n(1876),a=n(4534),c=n(971),o=n(1120),l=n(2404),d=n(5885),u=n(8026),h=n(6686),x=n(3790),f=n(5721),p=n(1565);function m(e){let{mode:t,streamName:n}=e,[a,c]=(0,f.useState)(!1);return(0,i.jsxs)(s.K,{bg:"gray.0",sx:e=>({borderTop:"1px solid ".concat(e.colors.gray[3])}),p:2,spacing:0,children:[(0,i.jsx)(r.Z,{children:a?(0,i.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,i.jsx)(h.Z,{size:14}),size:"xs",onClick:()=>c(!1),children:"Hide log"}):(0,i.jsx)(d.z,{variant:"subtle",compact:!0,leftIcon:(0,i.jsx)(x.Z,{size:14}),size:"xs",onClick:()=>c(!0),children:"Show log"})}),(0,i.jsx)(u.U,{in:a,transitionDuration:100,p:10,children:(0,i.jsx)(p.Z,{mode:t,streamName:n})})]})}var g=n(9296),j=n(8997),b=n(4094),v=n(3126),y=n(823),w=n(1685),D=n(7176),E=n(9578);function S(e){let{initialValues:t,onSubmit:n,saving:r}=e,a=(0,v.c)({initialValues:t,validate:{uid:(0,y.m)({min:1,max:255},"Must be between 1 and 255")}}),{classes:c}=(0,E.Z)(),o=(0,D.u)(a,c.dirtyInput);return(0,i.jsx)("form",{onSubmit:a.onSubmit(async e=>{let t=await n(e);t&&a.resetDirty()}),children:(0,i.jsxs)(s.K,{children:[(0,i.jsx)(j.r,{label:"Enabled",...o("isEnabled","checkbox")}),(0,i.jsx)(b.Y,{label:"OPCB Modbus ID:",mih:1,max:255,required:!0,...o("uid")}),(0,i.jsx)(w.Z,{type:"submit",inProgress:r,children:"Save"})]})})}var Z=n(4414),P=n(4911),k=n(3771),C=n(4423),M=n(8202),I=n(4406),_=n(6338);function N(e){let{parameters:t,values:n,paramsInfoShownMap:s,handleParamsInfoToggle:r,uid:a,token:c}=e;return(0,i.jsxs)(k.i,{w:"100%",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{style:{width:"120px"},children:"Address"}),(0,i.jsx)("th",{children:"Name"}),(0,i.jsx)("th",{style:{width:"140px"},children:"Current Value"})]})}),(0,i.jsx)("tbody",{children:Array.from(t.entries()).map(e=>{let[t,o]=e;return(0,i.jsx)(A,{parameter:o,infoShown:s["".concat(o.group).concat(o.registers[0])],handleParamsInfoToggle:r,uid:a,token:c,value:n["".concat(o.source,":").concat(o.redisPath)]},t)})})]})}let A=(0,f.memo)(function(e){let{parameter:t,infoShown:n,handleParamsInfoToggle:s,value:a,uid:c,token:o}=e;return(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{children:(0,i.jsx)(U,{registers:t.registers,type:t.type})}),(0,i.jsxs)("td",{children:[(0,i.jsxs)(C.k,{children:[(0,i.jsx)(M.x,{mr:5,span:!0,c:"gray.8",children:t.name}),(0,i.jsx)(I.k,{c:"blue",w:17,pt:2,onClick:()=>s("".concat(t.group).concat(t.registers[0])),children:!t.hiddenDescription&&(n?(0,i.jsx)(h.Z,{size:14}):(0,i.jsx)(x.Z,{size:14}))})]}),!t.hiddenDescription&&(0,i.jsx)(u.U,{in:n,transitionDuration:100,children:(0,i.jsx)(r.Z,{mih:50,children:n&&(0,i.jsx)(O,{parameter:t,uid:c,token:o})})})]}),(0,i.jsx)("td",{children:(0,i.jsx)(M.x,{c:"green",children:a||"-"})})]})},(e,t)=>e.infoShown===t.infoShown&&e.value===t.value);function O(e){let{parameter:t,token:n,uid:a}=e,[c,o]=(0,f.useState)([]);return(0,f.useEffect)(()=>{let e=async()=>{try{o([...(await (0,_.$b)(n,t.type,t.registers[0],t.registers.length,a)).map(e=>e.toFixed(0))])}catch(e){console.error(e)}},i=(0,P.As)(e,5e3);return()=>{i()}},[]),(0,i.jsxs)(s.K,{spacing:2,children:[(0,i.jsx)(M.x,{c:"dimmed",children:t.description}),(0,i.jsx)(C.k,{wrap:"wrap",gap:2,children:t.registers.map((e,t)=>(0,i.jsxs)(r.Z,{spacing:4,mr:5,children:[(0,i.jsx)(M.x,{c:"gray.7",children:"".concat(e,":")}),(0,i.jsx)(M.x,{c:"green",children:c[t]||"-"})]},t))})]})}function U(e){let{registers:t,type:n}=e;n=n[0];let s=1===t.length?"".concat(t[0]):"".concat(Math.min(...t),"-").concat(Math.max(...t));return(0,i.jsxs)(r.Z,{spacing:4,children:[(0,i.jsx)(M.x,{children:s}),(0,i.jsx)(M.x,{c:"dimmed",children:n})]})}function z(e){let{parameters:t,token:n,uid:s}=e,[r,a]=(0,f.useState)([]),[c,o]=(0,f.useState)({}),[l,d]=(0,f.useState)(t.reduce((e,t)=>(e["".concat(t.group).concat(t.registers[0])]=!1,e),{})),u=function(e){var t,n;let i=new Map;for(let n of e){let e=n.group;i.has(e)||i.set(e,[]),null===(t=i.get(e))||void 0===t||t.push(n)}for(let e of Array.from(i.keys()))i.set(e,(null===(n=i.get(e))||void 0===n?void 0:n.sort((e,t)=>e.registers[0]-t.registers[0]))||[]);return i}(t.sort((e,t)=>e.group.localeCompare(t.group)));(0,f.useEffect)(()=>{let e=async()=>{if(!r.length)return;let e=[],t=[],i=new Map;for(let n of r){let s=u.get(n);if(!s)continue;let r=0;for(let n of s)if("modbus"===n.source){var a;let e=n.registers[0],t=(null===(a=i.get(e-r))||void 0===a?void 0:a.quantity)||0,s=t+1;i.set(e-r,{quantity:s,type:n.type}),r=s}else{if(!n.redisPath)continue;"config"===n.source?e.push(n.redisPath):t.push(n.redisPath)}}let c={};if(e.length){let t=await (0,P.wv)(n,e);for(let e in t)c["config:".concat(e)]=t[e]}if(t.length){let e=await (0,P.UK)(n,t);for(let t in e)c["state:".concat(t)]=e[t]}if(i.size)for(let[e,t]of Array.from(i.entries())){let i=await (0,_.$b)(n,t.type,e,t.quantity,s);for(let[t,n]of Array.from(i.entries()))c["modbus:".concat(e+t)]=n.toFixed(0)}o(c)},t=(0,P.As)(e,5e3);return()=>{t()}},[r]);let h=e=>{let t={...l};for(let n in t[e]=!t[e],t)n!==e&&(t[n]=!1);d(t)};return(0,i.jsx)(Z.U,{radius:"xs",transitionDuration:100,multiple:!0,styles:{control:{"&[data-active]":{backgroundColor:"#f8f9fa"}}},onChange:e=>{a([...e])},children:Array.from(u.entries()).map(e=>{let[t,a]=e;return(0,i.jsxs)(Z.U.Item,{value:t,children:[(0,i.jsx)(Z.U.Control,{c:"blue",children:t}),(0,i.jsx)(Z.U.Panel,{p:0,children:r.includes(t)&&(0,i.jsx)(N,{parameters:a,values:c,paramsInfoShownMap:l,handleParamsInfoToggle:h,uid:s,token:n})})]},t)})})}var K=n(8581),T=n(9016),B=n(4579);async function V(e){let[t,n]=e,i=await (0,P.wv)(n,["virtualDevice:isEnabled","virtualDevice:uid"]);return{isEnabled:"true"===i["virtualDevice:isEnabled"],uid:parseInt(i["virtualDevice:uid"],10)}}async function q(e){let t=(0,B.bH)(),n={"virtualDevice:isEnabled":e.isEnabled?"true":"false","virtualDevice:uid":e.uid.toString()};await (0,B.ri)(t,"/api/confs/set/",{method:"POST",body:JSON.stringify(n)})}async function Q(e){let[t,n]=e,i=await (0,P.UK)(n,["virtualDevice:uid","virtualDevice:isEnabled"]);return{uid:Number(i["virtualDevice:uid"]),isEnabled:"true"===i["virtualDevice:isEnabled"]}}async function F(e){let[t,n]=e,i=await (0,P.UK)(n,["virtualDevice:modbusParameters"]);return JSON.parse(i["virtualDevice:modbusParameters"])}function H(){let e=function(){let e=(0,B.tQ)("modbus-opcb",V);return{...e}}(),t=(0,B.tQ)("opcbModbus-status",Q,{refreshInterval:1e3}),n=(0,B.tQ)("opcbModbus-params",F),{token:d}=(0,B.pk)(),u=e.data,h=t.data,x=n.data;return u&&h&&x&&d?(0,i.jsx)(o.Z,{pageId:"opcb-modbus-access",title:"OPCB Modbus Access",children:(0,i.jsx)(s.K,{children:(0,i.jsx)(K.Z,{name:"OPCB Modbus Access",icon:h.isEnabled?(0,i.jsx)(a.Z,{}):(0,i.jsx)(c.Z,{}),status:h.isEnabled?"connected":"disabled",settings:{title:"OPCB Modbus settings",form:S,useSettings:()=>({data:{...u,formMode:"update"},error:void 0,isValidating:!1,isLoading:!1,mutate:async()=>void 0}),save:q,onSettingsUpdate:()=>{e.mutate()}},children:h.isEnabled?(0,i.jsxs)(s.K,{spacing:"sm",children:[(0,i.jsx)(r.Z,{align:"start",p:"sm",children:(0,i.jsx)(T.Z,{name:"Modbus ID",mainVal:h.uid})}),(0,i.jsx)(z,{parameters:x,token:d,uid:h.uid}),(0,i.jsx)(m,{mode:"rtu-no-crc",streamName:"VIR"})]}):(0,i.jsx)(l.Z,{icon:(0,i.jsx)(c.Z,{}),text:"OPCB Modbus is disabled in settings."})})})}):(0,i.jsx)(g.Z,{pageTitle:"Modbus TCP Server",contentIsLoading:!0})}}},function(e){e.O(0,[634,733,301,979,964,105,856,296,205,774,888,179],function(){return e(e.s=264)}),_N_E=e.O()}]);