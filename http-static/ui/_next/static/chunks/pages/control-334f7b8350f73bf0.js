(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[843],{2031:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/control",function(){return s(9226)}])},7723:function(e,t,s){"use strict";var i=s(9025);t.Z=(0,i.k)(e=>({dirtyInput:{backgroundColor:e.colors.blue[0]}}))},3732:function(e,t,s){"use strict";s.d(t,{Z:function(){return StatusBlock}});var i=s(966),n=s(4418),a=s(462),r=s(7344),o=s(3979),d=s(9956),l=s(9977),c=s(3127),u=s(8637);function StatusBlock(e){let t="connected"===e.status?"green":"warn"===e.status?"orange":"disconnected"===e.status?"red":"gray";return(0,i.jsx)(n.X,{h:"100%",withBorder:!0,children:(0,i.jsxs)(a.K,{spacing:0,h:"100%",children:[(0,i.jsxs)(r.Z,{position:"apart",align:"center",p:"xs",sx:e=>({borderBottom:"1px solid ".concat(e.colors.gray[3])}),children:[(0,i.jsxs)(r.Z,{spacing:"xs",noWrap:!0,children:[(0,i.jsx)(o.k,{color:t,variant:"light",children:e.icon}),(0,i.jsx)(d.x,{weight:500,c:t,transform:"uppercase",children:e.name}),e.addEl&&"string"==typeof e.addEl?(0,i.jsx)(d.x,{c:"dimmed",size:"sm",children:e.addEl}):e.addEl]}),(0,i.jsxs)(r.Z,{spacing:"xs",noWrap:!0,children:[e.addElRight,e.settingsAction&&(0,i.jsx)(l.A,{color:"blue",onClick:e.settingsAction,children:(0,i.jsx)(u.Z,{size:18})})]})]}),(0,i.jsx)(c.x,{bg:e.bg,h:"100%",children:e.children})]})})}},169:function(e,t,s){"use strict";s.d(t,{Z:function(){return StatusBlockWithSettings}});var i=s(966),n=s(3900),a=s(8253),r=s(3732);function StatusBlockWithSettings(e){let[t,s]=(0,n.useState)(!1);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.Z,{...e.settings,opened:t,setOpened:s}),(0,i.jsx)(r.Z,{...e,settingsAction:()=>s(!0),children:e.children})]})}},829:function(e,t,s){"use strict";s.d(t,{Z:function(){return WithConfirmation}});var i=s(966),n=s(4512),a=s(462),r=s(9956),o=s(7344),d=s(3283),l=s(3900);function WithConfirmation(e){let{children:t,title:s,description:c,buttonText:u,isLevelGood:h}=e,[p,x]=(0,l.useState)(!1);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.u,{opened:p,onClose:()=>x(!1),withCloseButton:!1,zIndex:400,children:(0,i.jsxs)(a.K,{children:[(0,i.jsx)(r.x,{fz:"md",weight:500,align:"center",children:s}),(0,i.jsx)(r.x,{fz:"sm",c:"gray.7",align:"center",children:c}),(0,i.jsxs)(o.Z,{position:"center",children:[(0,i.jsx)(d.z,{color:h?"green":"orange",onClick:()=>{t.props.onClick(),x(!1)},children:u}),(0,i.jsx)(d.z,{color:h?"orange":"green",onClick:()=>x(!1),children:"Cancel"})]})]})}),(0,i.jsx)(t.type,{...t.props,onClick:()=>x(!0)})]})}},7219:function(e,t,s){"use strict";s.d(t,{Mx:function(){return saveProcedure},_B:function(){return getDirtyValues},_N:function(){return useFormWithInitialUpdates},uA:function(){return makeInputPropsGen}});var i=s(966),n=s(7344),a=s(9956),r=s(9724),o=s(6680),d=s(7017),l=s(2922),c=s(1457),u=s(3900),h=s(9804);async function saveProcedure(e){(0,o.yK)("settings-save"),(0,o.c0)({id:"settings-save",withCloseButton:!0,autoClose:!1,loading:!0,icon:null,color:"orange",title:"Saving settings...",message:"Please wait while the new settings are applied..."});try{await e()}catch(e){(0,o.wD)({id:"settings-save",loading:!1,withCloseButton:!0,color:"red",icon:(0,i.jsx)(d.Z,{}),title:"Error saving settings",message:"There was an error saving settings. Please check form data and try again."}),console.error(e);return}(0,o.wD)({id:"settings-save",loading:!1,withCloseButton:!0,autoClose:1e3,color:"green",icon:(0,i.jsx)(l.Z,{}),title:"Settings saved",message:"Settings were saved and applied successfully."})}function makeInputPropsGen(e,t,s){return function(r){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"input",d=arguments.length>2?arguments[2]:void 0;return function(e,t,s,r,o){let d=e.getInputProps(t,s),l=o&&o>300;return{...d,classNames:{input:e.isDirty(t)&&r||void 0},inputContainer:l?e=>(0,i.jsxs)(i.Fragment,{children:[e,(0,i.jsxs)(n.Z,{spacing:3,c:"orange",mt:2,align:"center",children:[(0,i.jsx)(c.Z,{size:11,style:{marginTop:-1}}),(0,i.jsxs)(a.x,{fz:"xs",children:["Updated: ",(0,h.LU)(1e3*o)," ago."]})]})]}):void 0}}(e,r,{...s,type:o},t,d)}}function useFormWithInitialUpdates(e){let t=(0,r.c)(e);return(0,u.useEffect)(()=>{for(let s in t.values)t.isDirty(s)||t.setFieldValue(s,e.initialValues[s]);t.resetDirty({...e.initialValues})},[...Object.values(e.initialValues)]),t}function getDirtyValues(e){return Object.fromEntries(Object.entries(e.values).filter(t=>{let[s,i]=t;return e.isDirty(s)&&void 0!==i}))}},1489:function(e,t,s){"use strict";s.d(t,{Y:function(){return useWebSocketStream}});var i=s(3900),n=s(1264),a=s(9804);function useWebSocketStream(e,t,s){let r=window.location.hostname,o=window.location.port,d="https:"===window.location.protocol?"wss":"ws",l="".concat(d,"://").concat(r,":").concat(o).concat(e),[c,u]=(0,i.useState)([]),{lastMessage:h,readyState:p}=(0,n.ZP)(l,{onError:e=>console.error("Log socket closed with error: ".concat(e)),onClose:e=>{console.log("Log socket closed: "+e),u(e=>e.concat({id:Math.floor(1e9*Math.random()),raw:"Log socket interrupted.",date:(0,a.k6)(new Date),type:"close"}))},onOpen:()=>{u(e=>e.concat({id:Math.floor(1e9*Math.random()),raw:"Log socket opened.",date:(0,a.k6)(new Date),type:"open"}))},shouldReconnect:()=>!0,reconnectAttempts:5,reconnectInterval:1e3});return(0,i.useEffect)(()=>{null===h||s||u(e=>{let s=t?t(h.data):h.data;return e.find(e=>e.id===s.id)?e:e.concat(s).slice(-1e3)})},[h,u]),{messageHistory:c,setMessageHistory:u,socketReadyState:p}}},9226:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return Page}});var i,n,a=s(966),r=s(462),o=s(6356),d=s(5782),l=s(4418),c=s(7344),u=s(9956),h=s(3127),p=s(3283),x=s(6366),g=s(7259),m=s(2348),f=s(4708),j=s(8482),v=s(7147),b=s(3174),y=s(3900);function CollapseWithHeader(e){let{children:t,title:s}=e,[i,n]=(0,y.useState)(!1);return(0,a.jsx)(l.X,{withBorder:!0,p:"md",children:(0,a.jsxs)(r.K,{children:[(0,a.jsxs)(c.Z,{spacing:"xs",onClick:()=>n(!i),sx:e=>({cursor:"pointer",color:e.colors.blue[6]}),children:[i?(0,a.jsx)(v.Z,{size:14}):(0,a.jsx)(b.Z,{size:14}),(0,a.jsx)(u.x,{size:"sm",transform:"uppercase",weight:700,color:"blue",children:s})]}),(0,a.jsx)(j.U,{in:i,children:(0,a.jsx)(c.Z,{mih:100,children:i&&t})})]})})}var w=s(8598),T=s(1489);function LogText(e){let{urlPath:t}=e,{messageHistory:s}=(0,T.Y)(t,e=>(function(e){let[t,...s]=e.split(" "),[i,n]=t.split("-"),a=1e3*Number(i)+Number(n);return{id:a,data:s.join(" ")}})(e)),i=(0,y.createRef)(),n=s.map(e=>(0,a.jsx)(S,{record:e},e.id));return(0,a.jsx)(w.x,{style:{height:"550px"},ref:i,children:(0,a.jsx)(u.x,{fz:12,ff:"monospace",children:n})})}let S=(0,y.memo)(function(e){let{record:t}=e,s="data"in t?t.data:t.raw;return(0,a.jsx)("div",{dangerouslySetInnerHTML:{__html:'<div class="no-wrap">'.concat(s,"</div>")}})},(e,t)=>e.record.id===t.record.id);var C=s(2094),Z=s(3624),k=s(2546),R=s(4224),A=s(9977),U=s(1536),z=s(2484),P=s(7816),O=s(52);async function sshKeysFetcher(e){let[t,s]=e;return(await (0,O.ri)(s,t)).json()}async function saveSshKeys(e){let t=(0,O.bH)();await (0,O.ri)(t,"/api/set-ssh-authkeys/",{method:"POST",body:JSON.stringify({keys:e.map(e=>e.trim())})})}var M=s(3732),B=s(829),D=s(8253),F=s(2701),K=s(9724),I=s(7452),N=s(7219),E=s(7723);function AddSshKeyForm(e){let{initialValues:t,onSubmit:s,saving:i}=e,{classes:n}=(0,E.Z)(),o=(0,K.c)({initialValues:{newKey:""},validate:{newKey:e=>{let s=e.split(" ");return 3!==s.length?"Key must have 3 parts separated by spaces.":t.includes(e)?"Key already exists.":void 0}}}),d=(0,N.uA)(o,n.dirtyInput);return(0,a.jsx)("form",{onSubmit:o.onSubmit(e=>s([...t,e.newKey.trim()])),children:(0,a.jsxs)(r.K,{children:[(0,a.jsx)(F.g,{label:"Public key:",...d("newKey"),required:!0,autosize:!0,description:'Copy and paste the public part of the SSH key "as is". It will be added to the end of /root/.ssh/authorized_keys',placeholder:"ssh-rsa AAAAB3NzaC1yc2EAAAABJQAA...",minRows:3,styles:{root:{flexGrow:1},input:{fontFamily:"monospace"}}}),(0,a.jsx)(I.Z,{type:"submit",inProgress:i,children:"Add SSH key to /root/.ssh/authorized_keys"})]})})}function SshKeysControl(){let e=function(){let e=(0,O.tQ)("/api/list/ssh-authkeys/",sshKeysFetcher);return{...e}}(),[t,s]=(0,y.useState)(!1),i=e.data;return(0,a.jsx)(a.Fragment,{children:i?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(D.Z,{title:"Add authorized SSH key",onSettingsUpdate:()=>{e.mutate()},form:AddSshKeyForm,useSettings:()=>({data:i,error:void 0,isValidating:!1,isLoading:!1,mutate:async()=>void 0}),save:saveSshKeys,opened:t,setOpened:s}),(0,a.jsx)(M.Z,{status:"disabled",name:"AUTHORIZED SSH KEYS",icon:(0,a.jsx)(U.Z,{}),addEl:(0,a.jsx)(p.z,{ml:"sm",leftIcon:(0,a.jsx)(z.Z,{size:14}),compact:!0,onClick:()=>s(!0),children:"Add key"}),addElRight:(0,a.jsxs)(u.x,{fz:"xs",color:"gray.6",children:["Keys are stored in ",(0,a.jsx)(k.E,{children:"/root/.ssh/authorized_keys"})," file."]}),children:i.length?(0,a.jsx)(R.i,{captionSide:"top",children:(0,a.jsx)("tbody",{children:i.map((t,s)=>(0,a.jsx)(SshKeyRow,{sshkey:t,sshKeys:i,mutate:e.mutate},s))})}):(0,a.jsxs)(u.x,{ta:"center",color:"gray.6",size:"sm",p:10,children:["File ",(0,a.jsx)(k.E,{children:"/root/.ssh/authorized_keys"})," is empty."]})})]}):(0,a.jsx)(c.Z,{position:"center",m:"lg",children:(0,a.jsx)(Z.a,{})})})}function SshKeyRow(e){let{sshkey:t,sshKeys:s,mutate:i}=e,n=t.split(" ");n.length>3&&n.shift();let r=n[2];return(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{children:(0,a.jsx)("div",{style:{fontWeight:"bold",maxWidth:130,overflow:"hidden",textOverflow:"ellipsis"},children:r})}),(0,a.jsx)("td",{children:(0,a.jsx)(k.E,{style:{wordBreak:"break-all"},children:t})}),(0,a.jsx)("td",{children:(0,a.jsx)("div",{style:{maxWidth:30},children:(0,a.jsx)(B.Z,{title:"Delete ssh key",description:'Are you sure you want to delete the authorized SSH key "'.concat(r,'"?'),buttonText:"Delete",children:(0,a.jsx)(A.A,{color:"red",onClick:async()=>{let e=s.filter(e=>e!==t);await saveSshKeys(e),i()},children:(0,a.jsx)(P.Z,{size:18})})})})})]})}var W=s(480),_=s(2440),H=s(2242),L=s(431),V=s(1457),G=s(2922),J=s(2968),X=s(5897),Y=s(3738);async function settingsFetcher(e){let[t,s]=e,i=await (0,Y.wv)(s,["global:updateMode","global:autoUpdateTimeRange:from","global:autoUpdateTimeRange:till"]);return{mode:i["global:updateMode"],autoUpdateTimeRange:{from:i["global:autoUpdateTimeRange:from"],till:i["global:autoUpdateTimeRange:till"]}}}function useSettings(){let e=(0,O.tQ)("update-settings",settingsFetcher);return{...e}}async function saveSettings(e){let t={"global:updateMode":e.mode,"global:autoUpdateTimeRange:from":"".concat(e.autoUpdateTimeRange.from),"global:autoUpdateTimeRange:till":"".concat(e.autoUpdateTimeRange.till)};return(0,Y.NC)(t)}async function runUpgrade(e){let t=(0,O.bH)();await (0,O.ri)(t,"/api/run-upgrade/",{method:"POST",body:JSON.stringify({ref:e})})}var Q=s(1827),q=s(6104),$=s(2061),ee=s(169),et=s(6886),es=s(1391);function UpdateSettingsForm(e){let{initialValues:t,onSubmit:s,saving:i}=e,n=(0,K.c)({initialValues:t,validate:{}}),{classes:o}=(0,E.Z)(),d=(0,N.uA)(n,o.dirtyInput);return(0,a.jsx)("form",{onSubmit:n.onSubmit(async e=>{let t=await s(e);t&&n.resetDirty()}),children:(0,a.jsxs)(r.K,{children:[(0,a.jsxs)(r.K,{spacing:5,children:[(0,a.jsx)(et.Ph,{withinPortal:!0,label:"Update mode:",data:[{label:"Disable updates completely",value:"disabled"},{label:"Manual updates",value:"manual"},{label:"Automatically apply patch updates",value:"auto-only-patch"},{label:"Automatically apply minor updates",value:"auto-only-minor"},{label:"Automatically apply all updates",value:"auto-all"}],...d("mode")}),"disabled"===n.values.mode&&(0,a.jsx)(u.x,{fz:"xs",c:"orange",children:"In this mode OPCB will not check for any available updates. You may miss security fixes. We recommend to set this setting to “Manual updates” instead."}),"auto-all"===n.values.mode&&(0,a.jsx)(u.x,{fz:"xs",c:"orange",children:"It is not recommended to use this setting, because major updates should be installed with user supervision. Use “Automatically apply minor updates” instead, you will be able to install major updates on this page."})]}),"disabled"!==n.values.mode&&"manual"!==n.values.mode&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u.x,{fz:"sm",mt:"xs",fw:"bold",children:"Auto-update time period:"}),(0,a.jsx)(es.M,{label:"From:",...d("autoUpdateTimeRange.from")}),(0,a.jsx)(es.M,{label:"Till:",...d("autoUpdateTimeRange.till")})]}),(0,a.jsx)(I.Z,{type:"submit",inProgress:i,children:"Save"})]})})}function UpdatesControl(e){let{}=e,t=useSettings(),s=(0,q.$z)(),i=(0,Q.A)();if(!t.data||!s.data)return(0,a.jsx)(c.Z,{position:"center",m:"lg",children:(0,a.jsx)(Z.a,{})});let n=t.data,o=s.data;return(0,a.jsx)(ee.Z,{name:"Firmware version and updates",icon:"disabled"===o.state||"no-repo"===o.state?(0,a.jsx)(_.Z,{}):(0,a.jsx)(H.Z,{}),status:"disabled"===o.state||"no-repo"===o.state?"disabled":"broken-repo"===o.state||"dirty-repo"===o.state?"warn":"connected",settings:{title:"Firmware update settings",form:UpdateSettingsForm,useSettings:()=>({data:{...n,formMode:"update"},error:void 0,isValidating:!1,isLoading:!1,mutate:async()=>void 0}),save:saveSettings,onSettingsUpdate:async()=>{await t.mutate(),await s.mutate(),await i.mutate()}},children:(0,a.jsxs)(r.K,{align:"center",spacing:0,children:[(0,a.jsx)(h.x,{p:"xl",children:(0,a.jsx)(CurrentVersionInfo,{info:o.current})}),(0,a.jsx)(c.Z,{w:"100%",p:"xl",sx:e=>({backgroundColor:e.colors.gray[0],borderTop:"1px solid ".concat(e.colors.gray[3])}),position:"center",children:(0,a.jsxs)(r.K,{align:"center",children:[(0,a.jsx)(UpdatesStatusInfo,{status:o,settings:n}),o.lastUpgradeFailure&&(0,a.jsxs)(r.K,{c:"red",children:[(0,a.jsx)(u.x,{fz:"md",fw:"bold",children:(0,a.jsxs)("div",{children:["There was an error during the last upgrade attempt to version"," ",o.lastUpgradeFailure.ref,":"]})}),(0,a.jsx)(u.x,{fz:"xs",children:(0,a.jsx)("pre",{children:o.lastUpgradeFailure.error})})]})]})})]})})}function CurrentVersionInfo(e){let{info:t}=e;return(0,a.jsxs)(r.K,{spacing:"xs",fz:"sm",align:"center",children:[(0,a.jsxs)(c.Z,{children:[(0,a.jsxs)(u.x,{fz:"md",children:["Current firmware version: ",(0,a.jsx)("b",{children:t.version})]}),(0,a.jsx)($.Z,{version:t.version,children:"Release information"})]}),(0,a.jsxs)(c.Z,{c:"grey",children:[(0,a.jsxs)(u.x,{children:["Released on: ",(0,a.jsx)("b",{children:t.date})]}),(0,a.jsxs)(u.x,{children:["GIT tag: ",(0,a.jsx)("b",{children:t.tag})]}),(0,a.jsxs)(u.x,{children:["SHA: ",(0,a.jsx)("b",{children:t.sha})]})]})]})}function UpdatesStatusInfo(e){let{status:t,settings:s}=e;return"disabled"===t.state?(0,a.jsx)(UpdatesDisabled,{}):"broken-repo"===t.state?(0,a.jsx)(BrokenRepo,{}):"dirty-repo"===t.state?(0,a.jsx)(DirtyRepo,{}):"no-repo"===t.state?(0,a.jsx)(NoRepo,{}):"no-update"===t.state?(0,a.jsx)(NoUpdate,{}):t.scheduledUpgradeToTag?(0,a.jsx)(ScheduledUpgrade,{status:t,settings:s}):(0,a.jsx)(UpdateAvailable,{status:t})}function UpdatesDisabled(){return(0,a.jsxs)(c.Z,{c:"grey",spacing:5,children:[(0,a.jsx)(L.Z,{size:18}),(0,a.jsx)(u.x,{children:"Updates are disabled by user settings."})]})}function BrokenRepo(){return(0,a.jsxs)(r.K,{spacing:2,align:"center",children:[(0,a.jsxs)(c.Z,{c:"red",spacing:5,children:[(0,a.jsx)(V.Z,{size:22}),(0,a.jsx)(u.x,{children:"GIT repository is broken. Updates are disabled."})]}),(0,a.jsxs)(u.x,{fz:"sm",color:"grey",children:["Please contact support for help:"," ",(0,a.jsx)(W.e,{href:"mailto:support@overvis.com",children:"support@overvis.com"})]})]})}function DirtyRepo(){return(0,a.jsxs)(r.K,{spacing:2,align:"center",children:[(0,a.jsxs)(c.Z,{c:"orange",spacing:5,children:[(0,a.jsx)(V.Z,{size:22}),(0,a.jsx)(u.x,{children:"GIT repository contains local modifications. Updates are disabled."})]}),(0,a.jsxs)(u.x,{fz:"sm",color:"grey",children:["Please contact support for help:"," ",(0,a.jsx)(W.e,{href:"mailto:support@overvis.com",children:"support@overvis.com"})]})]})}function NoRepo(){return(0,a.jsxs)(r.K,{c:"grey",spacing:2,align:"center",children:[(0,a.jsxs)(c.Z,{spacing:5,children:[(0,a.jsx)(L.Z,{size:18}),(0,a.jsx)(u.x,{children:"OPCB runtime was not checked out from GIT repository. Updates are disabled."})]}),(0,a.jsxs)(u.x,{fz:"sm",children:["Please contact support if you need to enable updates:"," ",(0,a.jsx)(W.e,{href:"mailto:support@overvis.com",children:"support@overvis.com"})]})]})}function NoUpdate(){let[e,t]=(0,y.useState)(!1),s=(0,q.$z)(),i=(0,Q.A)();return(0,a.jsxs)(c.Z,{children:[(0,a.jsxs)(c.Z,{c:"green",spacing:8,children:[(0,a.jsx)(G.Z,{size:22}),(0,a.jsx)(u.x,{children:"Your version is up to date."})]}),(0,a.jsx)(p.z,{variant:"subtle",leftIcon:(0,a.jsx)(J.Z,{size:"16px"}),loading:e,onClick:async()=>{t(!0),await (0,q.Df)(),await s.mutate(),await i.mutate(),t(!1)},children:"Refresh"})]})}function ScheduledUpgrade(e){var t,s,i,n,o,d,l,h,x;let g;let{status:m,settings:f}=e,j=m.scheduledUpgradeToTag,v=j,b=j,w=!1;(null===(t=m.latestPatch)||void 0===t?void 0:t.tag)===b&&(v=null===(n=m.latestPatch)||void 0===n?void 0:n.version,b="".concat(v||b," (patch or security fix)"),g=null===(o=m.latestPatch)||void 0===o?void 0:o.changelogMarkdown),(null===(s=m.latestMinor)||void 0===s?void 0:s.tag)===b&&(v=null===(d=m.latestMinor)||void 0===d?void 0:d.version,b="".concat(v||b," (minor update)"),g=null===(l=m.latestMinor)||void 0===l?void 0:l.changelogMarkdown),(null===(i=m.latestMajor)||void 0===i?void 0:i.tag)===b&&(v=null===(h=m.latestMajor)||void 0===h?void 0:h.version,b="".concat(v||b," (major update)"),g=null===(x=m.latestMajor)||void 0===x?void 0:x.changelogMarkdown,w=!0),b||(b="unknown");let[T,S]=(0,y.useState)(!1),C=(0,q.$z)(),Z=useSettings(),k=(0,Q.A)();return(0,a.jsxs)(r.K,{c:"grey",spacing:2,align:"center",children:[(0,a.jsxs)(c.Z,{spacing:"sm",children:[(0,a.jsxs)(c.Z,{c:w?"orange":"green",spacing:5,children:[(0,a.jsx)(X.Z,{size:18}),(0,a.jsxs)(u.x,{children:["Scheduled update: ",(0,a.jsx)("b",{children:b})]})]}),g&&(0,a.jsx)($.Z,{version:v||b,markdownContent:g,children:"List of changes"})]}),(0,a.jsxs)(u.x,{fz:"sm",children:["Update will be applied between ",f.autoUpdateTimeRange.from," and"," ",f.autoUpdateTimeRange.till,"."]}),j&&(0,a.jsxs)(c.Z,{pt:"sm",children:[(0,a.jsx)(UpdateButton,{tag:j}),(0,a.jsx)(B.Z,{title:"Cancel the update and disable auto-updates",description:"This action will cancel the current update and switch OPCB to manual update mode.",buttonText:"Disable auto-updates",children:(0,a.jsx)(p.z,{variant:"subtle",loading:T,onClick:async()=>{S(!0),await (0,q.hH)(),await C.mutate(),await Z.mutate(),await k.mutate(),S(!1)},children:"Cancel and disable"})})]})]})}function UpdateButton(e){let{tag:t}=e,{actionHandler:s}=(0,f.vu)();return(0,a.jsx)(B.Z,{title:"Update to version ".concat(t),description:"This action will preform the upgrade of the OPCB runtime to a new version right now. Device will be switched offline for about a minute.",buttonText:"Update now",children:(0,a.jsx)(p.z,{onClick:()=>s({actionProcess:async()=>{await runUpgrade(t)},afterAction:async()=>{let e=await (0,q.s_)();if(e.lastFailedUpgradeRef)throw Error("Failed to upgrade to version ".concat(e.lastFailedUpgradeRef))},title:"Updating firmware",failedTitle:"Firmware update failed",failedId:"firmware-update-failed",startActionText:"Waiting for update to start...",afterActionText:"Update started. Please wait...",successId:"firmware-update-success",successTitle:"Successful update",successMessage:"OPCB firmware updated to the latest version.",redirectToDashboardAfterAction:!0,delayBeforeDeviceWait:1e4}),children:"Update now"})})}function UpdateAvailable(e){var t,s,i,n,o,d,l,h,p;let x,g,m,f;let{status:j}=e;return("available-update-patch"===j.state&&(g=null===(t=j.latestPatch)||void 0===t?void 0:t.version,f=null===(s=j.latestPatch)||void 0===s?void 0:s.tag,x="".concat(g," (patch or security fix)"),m=null===(i=j.latestPatch)||void 0===i?void 0:i.changelogMarkdown),"available-update-minor"===j.state&&(g=null===(n=j.latestMinor)||void 0===n?void 0:n.version,f=null===(o=j.latestMinor)||void 0===o?void 0:o.tag,x="".concat(g," (minor update)"),m=null===(d=j.latestMinor)||void 0===d?void 0:d.changelogMarkdown),"available-update-major"===j.state&&(g=null===(l=j.latestMajor)||void 0===l?void 0:l.version,f=null===(h=j.latestMajor)||void 0===h?void 0:h.tag,x="".concat(g," (major update)"),m=null===(p=j.latestMajor)||void 0===p?void 0:p.changelogMarkdown),g&&f)?(0,a.jsxs)(r.K,{c:"grey",spacing:2,align:"center",children:[(0,a.jsxs)(c.Z,{spacing:"sm",children:[(0,a.jsxs)(c.Z,{c:"green",spacing:5,children:[(0,a.jsx)(X.Z,{size:18}),(0,a.jsxs)(u.x,{children:["New version is available: ",(0,a.jsx)("b",{children:x})]})]}),m&&(0,a.jsx)($.Z,{version:g,markdownContent:m,children:"List of changes"})]}),(0,a.jsx)(c.Z,{pt:"sm",children:(0,a.jsx)(UpdateButton,{tag:f})})]}):(0,a.jsx)(NoUpdate,{})}async function sendCommandToDevice(e){let t;let s=(0,O.bH)();if(0===e?t=await (0,O.ri)(s,"/api/restart/",{method:"POST",body:JSON.stringify({})}):1===e?t=await (0,O.ri)(s,"/api/reboot/",{method:"POST",body:JSON.stringify({})}):2===e&&(t=await (0,O.ri)(s,"/api/confs/reset/",{method:"POST",body:JSON.stringify({})})),(null==t?void 0:t.status)!==200)throw Error("request failed with status "+(null==t?void 0:t.status))}(i=n||(n={}))[i.RestartRuntime=0]="RestartRuntime",i[i.RebootDevice=1]="RebootDevice",i[i.ResetConfiguration=2]="ResetConfiguration";var ei=s(735);async function sdCardTestStatusFetcher(e){let[t,s]=e,i=await (0,Y.UK)(s,["sdTest:status","sdTest:error","sdTest:startedOn","sdTest:writeSpeedMbps","sdTest:readSpeedMbps"]);return{status:i["sdTest:status"]||"none",error:i["sdTest:error"],startedOn:void 0!==i["sdTest:startedOn"]?new Date(1e3*Number(i["sdTest:startedOn"])):void 0,writeSpeedMbps:void 0!==i["sdTest:writeSpeedMbps"]?Number(i["sdTest:writeSpeedMbps"]):void 0,readSpeedMbps:void 0!==i["sdTest:readSpeedMbps"]?Number(i["sdTest:readSpeedMbps"]):void 0}}var en=s(9804);async function startTest(){let e=(0,O.bH)();await (0,O.ri)(e,"/api/sd-test/start/",{method:"POST",body:JSON.stringify({}),timeoutMs:3e4})}function SdCardTest(){let e=(0,O.tQ)("sd-test-status",sdCardTestStatusFetcher),t=e.data,s=(0,y.useRef)();return t&&("finished"===t.status||"failed"===t.status)&&s.current&&window.clearInterval(s.current),(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(l.X,{bg:"gray.0",withBorder:!0,children:(0,a.jsxs)(r.K,{h:"100%",spacing:0,children:[(0,a.jsxs)(c.Z,{px:"md",py:"sm",sx:e=>({borderBottom:"1px solid ".concat(e.colors.gray[3])}),spacing:"xs",children:[(0,a.jsx)(ei.Z,{size:16}),(0,a.jsx)(u.x,{weight:500,children:"SD-card performance test"})]}),(0,a.jsx)(h.x,{h:"100%",p:"md",children:void 0===t?(0,a.jsx)(a.Fragment,{}):(0,a.jsxs)(r.K,{h:"100%",justify:"space-between",spacing:"sm",children:[(0,a.jsx)(u.x,{fz:"sm",mb:"md",children:"finished"===t.status?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(u.x,{mb:"xs",children:[(0,a.jsx)("b",{children:"Last test run:"})," ",t.startedOn&&(0,a.jsxs)(u.x,{span:!0,children:["(",(0,en.o0)(t.startedOn.getTime(),!0),")"]})]}),(0,a.jsx)(SpeedResult,{status:t,mode:"read"}),(0,a.jsx)(SpeedResult,{status:t,mode:"write"})]}):"ongoing"===t.status?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(u.x,{mb:"xs",children:[(0,a.jsx)("b",{children:"Test is running..."})," ",t.startedOn&&(0,a.jsxs)(u.x,{span:!0,children:["(",(0,en.o0)(t.startedOn.getTime(),!0),")"]})]}),(0,a.jsx)(SpeedResult,{status:t,mode:"read"}),(0,a.jsx)(SpeedResult,{status:t,mode:"write"})]}):"failed"===t.status?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(u.x,{mb:"xs",children:[(0,a.jsx)("b",{children:"Test failed"})," ",t.startedOn&&(0,a.jsxs)(u.x,{span:!0,children:["(",(0,en.o0)(t.startedOn.getTime(),!0),")"]})]}),(0,a.jsx)(u.x,{color:"red",children:t.error})]}):(0,a.jsx)(a.Fragment,{})}),(0,a.jsx)(p.z,{color:"green",disabled:"ongoing"===t.status,onClick:async()=>{await startTest(),e.mutate(),s.current=window.setInterval(()=>{e.mutate()},1e3)},children:"ongoing"===t.status?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(Z.a,{size:"xs",mr:"sm"}),"Running..."]}):"Start test"})]})})]})})})}function SpeedResult(e){let{status:t,mode:s}=e,i="read"===s?t.readSpeedMbps:t.writeSpeedMbps;return(0,a.jsxs)(u.x,{children:["read"===s?"Read":"Write"," speed:"," ",(0,a.jsxs)(u.x,{span:!0,c:void 0===i?"gray.6":i>=20?"green.6":"orange.6",children:[void 0===i?"-":i.toFixed(2)+" MB/s"," ",void 0!==i&&i<20?"(nominal: 20 MB/s)":""]})]})}function Page(){return(0,a.jsx)(C.Z,{pageTitle:"Control",children:(0,a.jsx)(Actions,{})})}function Actions(){var e;let{actionHandler:t}=(0,f.vu)(),s=(0,O.pk)();return(0,a.jsxs)(r.K,{children:[(0,a.jsx)(UpdatesControl,{}),(0,a.jsxs)(o.M,{cols:3,children:[(0,a.jsx)(ActionCard,{title:"Restart OPCB Runtime",icon:(0,a.jsx)(x.Z,{size:16}),description:"Restart OPCB runtime, reloading the configuration files and all services. The connection to the device will be lost temporarily after this action.",buttonText:"Restart runtime",confirmText:"Confirm restarting OPCB runtime.",confirmDescription:"The connection to the device will be lost temporarily.",action:()=>{t({actionProcess:async()=>{sendCommandToDevice(n.RestartRuntime)},title:"Restarting OPCB runtime",failedTitle:"Restart failed.",failedId:"restart-failed",startActionText:"Sending the command to the device...",afterActionText:"Command received by the device...",successId:"restart-success",successTitle:"OPCB runtime has been restarted.",successMessage:"Operation completed successfully.",redirectToDashboardAfterAction:!0,delayBeforeDeviceWait:5e3})}}),(0,a.jsx)(ActionCard,{title:"Reboot the device",icon:(0,a.jsx)(g.Z,{size:16}),description:"Soft-reboot of the device operating system. The connection to the device will be lost for a minute or more after this action.",buttonText:"Reboot device",confirmText:"Confirm rebooting OPCB device.",confirmDescription:"The connection to the device will be lost temporarily.",action:()=>{t({actionProcess:async()=>{sendCommandToDevice(n.RebootDevice)},title:"Rebooting OPCB",failedTitle:"Reboot failed.",failedId:"reboot-failed",startActionText:"Sending the command to the device...",afterActionText:"Command received by the device...",successId:"reboot-success",successTitle:"Device has been rebooted.",successMessage:"Operation completed successfully.",redirectToDashboardAfterAction:!0,delayBeforeDeviceWait:5e3})}}),(0,a.jsx)(ActionCard,{title:"Reset to the default configuration",icon:(0,a.jsx)(m.Z,{size:16}),description:"OPCB runtime configuration will be restored to the factory values after this action. As a consequence, the connection to the device may be lost. OPCB Wi-Fi will be automatically switched to the Access Point mode.",buttonText:"Reset configuration",confirmText:"Confirm resetting OPCB configuration to the factory values.",confirmDescription:"The connection to the device will be lost. To access the device, connect to OPCB Wi-Fi Access Point after this action.",action:()=>{t({actionProcess:async()=>{sendCommandToDevice(n.ResetConfiguration)},title:"Reseting OPCB configuration",failedTitle:"Reset failed.",failedId:"reset-failed",startActionText:"Sending the command to the device...",afterActionText:"Command received by the device...",successId:"reset-success",successTitle:"OPCB configuration has been reset.",successMessage:"Operation completed successfully.",messageAfterDeviceWaitTimeout:(0,a.jsx)(f.zU,{}),redirectToDashboardAfterAction:!0,delayBeforeDeviceWait:5e3})}})]}),(0,a.jsxs)(d.r,{children:[(0,a.jsx)(d.r.Col,{span:8,children:(0,a.jsx)(SshKeysControl,{})}),(0,a.jsx)(d.r.Col,{span:4,children:(0,a.jsx)(SdCardTest,{})})]}),(null===(e=s.token)||void 0===e?void 0:e.username)==="admin"&&(0,a.jsx)(CollapseWithHeader,{title:"Control bus stream log",children:(0,a.jsx)(LogText,{urlPath:"/api/log/bus/"})})]})}function ActionCard(e){let{title:t,icon:s,description:i,buttonText:n,confirmText:o,confirmDescription:d,action:x}=e;return(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(l.X,{bg:"gray.0",withBorder:!0,children:(0,a.jsxs)(r.K,{h:"100%",spacing:0,children:[(0,a.jsxs)(c.Z,{px:"md",py:"sm",sx:e=>({borderBottom:"1px solid ".concat(e.colors.gray[3])}),spacing:"xs",children:[s,(0,a.jsx)(u.x,{weight:500,children:t})]}),(0,a.jsx)(h.x,{h:"100%",p:"md",children:(0,a.jsxs)(r.K,{h:"100%",justify:"space-between",spacing:"sm",children:[(0,a.jsx)(u.x,{fz:"xs",children:i}),(0,a.jsx)(B.Z,{title:o,description:d,buttonText:n,children:(0,a.jsx)(p.z,{color:"orange",onClick:x,children:n})})]})})]})})})}}},function(e){e.O(0,[217,666,161,266,94,774,888,179],function(){return e(e.s=2031)}),_N_E=e.O()}]);