(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[687],{6654:function(e,t,r){"use strict";function isLengthValid(e,t){if("number"==typeof e)return t.length===e;let{max:r,min:i}=e,n=!0;return"number"==typeof r&&t.length>r&&(n=!1),"number"==typeof i&&t.length<i&&(n=!1),n}function hasLength(e,t){let r=t||!0;return t=>"string"==typeof t?isLengthValid(e,t.trim())?null:r:"object"==typeof t&&null!==t&&"length"in t&&isLengthValid(e,t)?null:r}r.d(t,{d:function(){return hasLength}})},9905:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/manufacture/restore",function(){return r(9469)}])},6035:function(e,t,r){"use strict";r.d(t,{Z:function(){return ManufactureLayout}});var i=r(966),n=r(9025),a=r(7344),o=r(2671),s=r(6849),c=r(7579),u=r(2767),l=r(7992),d=r(4736),h=r(5807),f=r(1149),v=r(6446),p=r(8410),g=r(2094);let m=(0,n.k)(e=>({tabsList:{borderBottom:"1px solid ".concat(e.colors.gray[4])},tab:{color:e.colors.blue[6],textTransform:"uppercase",fontSize:e.fontSizes.xs,"&:hover":{backgroundColor:"transparent",border:"transparent",color:e.colors.dark},"&[data-active]":{borderBottom:"2px solid #000",pointerEvents:"none"}}}));function ManufactureLayout(e){let{children:t,title:r,id:n}=e,y=(0,p.H)(),{classes:b}=m(),w=(0,v.useRouter)();if(!y.data)return(0,i.jsx)(g.Z,{pageTitle:"Manufacturing",contentIsLoading:!0});let x=y.data.internetConnected,j=y.data.wireguardConnected;return(0,i.jsxs)(g.Z,{pageTitle:"Manufacture :: ".concat(r),children:[j&&(0,i.jsx)(a.Z,{position:"center",children:(0,i.jsx)("a",{href:"/dyn-media/label.png",target:"_blank",children:(0,i.jsx)(o.E,{src:"/dyn-media/label.png",alt:"OPCB VPN information label.",maw:"260px"})})}),("restore"===n||"register"===n)&&(0,i.jsxs)(i.Fragment,{children:[j&&(0,i.jsx)(s.b,{my:"lg",icon:(0,i.jsx)(u.Z,{}),title:"Already authenticated.",color:"yellow",children:"This device is already authenticated on the remote server and has an access. By submitting this form you may lose the access or change the device's identity."}),!x&&(0,i.jsx)(s.b,{my:"lg",icon:(0,i.jsx)(u.Z,{}),title:"No internet access.",color:"yellow",children:"Active internet connection is required to restore the device's identity. Please check the device's settings."})]}),"test"===n&&!x&&(0,i.jsx)(s.b,{my:"lg",icon:(0,i.jsx)(u.Z,{}),title:"No internet access.",color:"red",children:"Active internet connection is required to run the tests."}),(0,i.jsxs)(c.m,{color:"dark",value:n,variant:"default",classNames:{tabsList:b.tabsList,tab:b.tab},onTabChange:e=>w.push("/manufacture/".concat(e)),children:[(0,i.jsxs)(c.m.List,{mb:"lg",children:[(0,i.jsx)(c.m.Tab,{value:"restore",icon:(0,i.jsx)(l.Z,{size:16}),children:"Restore identity"}),(0,i.jsx)(c.m.Tab,{value:"register",icon:(0,i.jsx)(d.Z,{size:16}),children:"Register"}),(0,i.jsx)(c.m.Tab,{value:"test",icon:(0,i.jsx)(h.Z,{size:16}),children:"Test"}),(0,i.jsx)(c.m.Tab,{value:"finalize",icon:(0,i.jsx)(f.Z,{size:16}),children:"Finalize"})]}),(0,i.jsx)(c.m.Panel,{value:n,children:t})]})]})}},1662:function(e,t,r){"use strict";r.d(t,{a:function(){return restoreDevice},t:function(){return registerDevice}});var i=r(52);async function registerDevice(e,t){let r=(0,i.bH)(),n=await (0,i.ri)(r,"/api/manufacture/register/",{method:"POST",body:JSON.stringify(e),timeoutMs:3e4},!1),throwError=e=>{throw t(e),Error(e)};if(200!==n.status){let e=await n.json();throw"MotherlandUnavailable"===e.errorCode&&throwError("Registration server is unavalable. Please contact support."),"IncorrectPrivateKey"===e.errorCode&&throwError("Incorrect device private key provided."),"InvalidLicense"===e.errorCode&&throwError("License ID or password is incorrect."),"LicenseQuotaExceeded"===e.errorCode&&throwError("The registration quota for this license is exceeded. Please contact Overvis support."),"DeviceRegisteredWithoutVpn"===e.errorCode&&throwError("This device was already registered without the VPN access. Please contact support."),"MacExists"===e.errorCode&&throwError('Device with the same MAC address was already registered with a different key. If you have an access to the previous private key (should be printed on the label), please use the "Restore" section. If the private key is lost, please contact support.'),Error("Registration request failed: ".concat(n.status,": ").concat(e.errorCode,": ").concat(e.errorMessage))}}async function restoreDevice(e,t){let r=(0,i.bH)(),n=await (0,i.ri)(r,"/api/manufacture/restore/",{method:"POST",body:JSON.stringify({privateKey:e}),timeoutMs:3e4},!1),throwError=e=>{throw t(e),Error(e)};if(200!==n.status){let e=await n.json();throw"MotherlandUnavailable"===e.errorCode&&throwError("Registration server is unavalable. Please contact support."),"IncorrectPrivateKey"===e.errorCode&&throwError("Can't generate public key. Incorrect device private key provided."),"DeviceNotFound"===e.errorCode&&throwError("Incorrect device private key provided. Device with resulting public key is not registered on server."),Error("Registration request failed: ".concat(n.status,": ").concat(e.errorCode,": ").concat(e.errorMessage))}}},8410:function(e,t,r){"use strict";r.d(t,{H:function(){return useManufacturerStatus}});var i=r(52),n=r(3738);async function manufacturerFetcher(e){let[t,r]=e,i=await (0,n.UK)(r,["wg:ping","wg:pubkey","inet:ping","wg:ping","overvisRc:mac","manufacturer:modeEnabled","manufacturer:licenseUuid","manufacturer:licensePassword","manufacturer:batchDescription"]),a=await (0,n.wv)(r,["overvisVpn:wireguard:privateKey"]),o={internetConnected:!1,wireguardConnected:!1,pubkey:i["wg:pubkey"],mac:i["overvisRc:mac"],manufacturerModeEnabled:!!i["manufacturer:modeEnabled"],licenseUuid:i["manufacturer:licenseUuid"],licensePassword:i["manufacturer:licensePassword"],batchDescription:i["manufacturer:batchDescription"],privateKey:a["overvisVpn:wireguard:privateKey"]},s=i["wg:ping"];s&&"unreachable"!==s&&(o.wireguardConnected=!0);let c=i["inet:ping"];return c&&"unreachable"!==c&&(o.internetConnected=!0),o}function useManufacturerStatus(){return(0,i.tQ)("manufacturer-status",manufacturerFetcher)}},9469:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return Page}});var i=r(966),n=r(462),a=r(6849),o=r(9956),s=r(6078),c=r(7344),u=r(3283),l=r(9724),d=r(6654),h=r(2767),f=r(3900),v=r(4708),p=r(6035),g=r(2094),m=r(1662),y=r(8410);function Page(){let e=(0,y.H)();return e.data?(0,i.jsx)(p.Z,{id:"restore",title:"Restore identity",children:(0,i.jsx)(ManufactRestoreForm,{privateKey:e.data.privateKey})}):(0,i.jsx)(g.Z,{pageTitle:"Manufacturing",contentIsLoading:!0})}function ManufactRestoreForm(e){let{privateKey:t}=e,{actionHandler:r}=(0,v.vu)(),[p,g]=(0,f.useState)(void 0),y=(0,l.c)({initialValues:{privateKey:t},validate:{privateKey:(0,d.d)({max:44},"Must be 44 characters long.")}});return(0,i.jsxs)(n.K,{h:"100%",children:[p&&(0,i.jsx)(a.b,{my:"lg",icon:(0,i.jsx)(h.Z,{}),title:"Registration error",color:"red",children:p}),(0,i.jsx)(o.x,{fz:"xs",c:"gray",children:"Warning! This action will not modify the device&s functions, but it will cause the device to assume the identity of another device on remote servers. This operation will communicate with a remote server to register the device&s identity. Only perform this action if you have lost the device with the specified private key or have restored its firmware to the factory firmware. Two devices with the same identity will conflict and will not be able to communicate with the remote servers."}),(0,i.jsx)("form",{onSubmit:y.onSubmit(()=>{r({actionProcess:async()=>(g(void 0),(0,m.a)(y.values.privateKey,g)),title:"Restoring OPCB",failedTitle:"Restore failed.",failedId:"restore-failed",startActionText:"Sending the data to the server...",afterActionText:"Restoring the device...",successId:"restore-success",successTitle:"OPCB has been restored.",successMessage:"Device identity restored successfully."})}),children:(0,i.jsxs)(n.K,{h:"100%",children:[(0,i.jsx)(s.o,{maw:"500px",label:"Enter the private key from the label to restore device registration:",...y.getInputProps("privateKey"),required:!0}),(0,i.jsx)(c.Z,{children:(0,i.jsx)(u.z,{type:"submit",children:"Restore"})})]})})]})}}},function(e){e.O(0,[217,666,161,767,94,774,888,179],function(){return e(e.s=9905)}),_N_E=e.O()}]);