(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[181],{4480:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/quick-setup",function(){return n(9552)}])},6773:function(e,t,n){"use strict";n.d(t,{s:function(){return c}});var a=n(6521),r=n(8742),i=n(9093),o=n(4130),s=n(5721);function c(e){let t=(0,o.useRouter)(),[n,c]=(0,s.useState)(!0);return(0,s.useEffect)(()=>{let e=()=>{c(!1)},n=()=>{c(!0)};return t.events.on("routeChangeStart",e),t.events.on("routeChangeComplete",n),t.events.on("routeChangeError",n),()=>{t.events.off("routeChangeStart",e),t.events.off("routeChangeComplete",n),t.events.off("routeChangeError",n)}},[t]),(0,s.useEffect)(()=>{e.dataLoaded&&n||e.dataErrored?!n||e.dataLoaded||e.dataErrored?(0,r.We)():(0,r.fD)(50):(0,r.QT)()},[e.dataLoaded,e.dataErrored,n]),(0,a.jsx)(i.V,{autoReset:!0})}},7176:function(e,t,n){"use strict";n.d(t,{M:function(){return s},u:function(){return c}});var a=n(6521),r=n(367),i=n(602),o=n(4239);async function s(e){(0,r.yK)("settings-save"),(0,r.c0)({id:"settings-save",withCloseButton:!0,autoClose:!1,loading:!0,icon:null,color:"orange",title:"Saving settings...",message:"Please wait while the new settings are applied..."});try{await e()}catch(e){(0,r.wD)({id:"settings-save",loading:!1,withCloseButton:!0,color:"red",icon:(0,a.jsx)(i.Z,{}),title:"Error saving settings",message:"There was an error saving settings. Please check form data and try again."}),console.error(e);return}(0,r.wD)({id:"settings-save",loading:!1,withCloseButton:!0,autoClose:1e3,color:"green",icon:(0,a.jsx)(o.Z,{}),title:"Settings saved",message:"Settings were saved and applied successfully."})}function c(e,t,n){return function(a){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"input";return function(e,t,n,a){let r=e.getInputProps(t,n);return{...r,classNames:{input:e.isDirty(t)&&a||void 0}}}(e,a,{...n,type:r},t)}}},6338:function(e,t,n){"use strict";n.d(t,{$b:function(){return m},EH:function(){return l},Gt:function(){return v},J4:function(){return u},PW:function(){return g},_:function(){return c},aL:function(){return d},eq:function(){return o},gY:function(){return f},nM:function(){return p}});var a=n(4579),r=n(1318),i=n(5105).Buffer;let o=[{code:1,name:"Read Coils"},{code:2,name:"Read Discrete Inputs"},{code:3,name:"Read Holding Registers"},{code:4,name:"Read Input Registers"},{code:5,name:"Write Single Coil"},{code:6,name:"Write Single Register"},{code:7,name:"Read Exception Status"},{code:8,name:"Diagnostics"},{code:11,name:"Get Comm Event Counter"},{code:12,name:"Get Comm Event Log"},{code:15,name:"Write Multiple Coils"},{code:16,name:"Write Multiple Registers"},{code:17,name:"Report Server ID"},{code:20,name:"Read File Record"},{code:21,name:"Write File Record"},{code:22,name:"Mask Write Register"},{code:23,name:"Read/Write Multiple Registers"},{code:24,name:"Read FIFO Queue"},{code:43,name:"Read Device Identification"}],s=new Int32Array([0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448]),c=[50,75,110,134,150,200,300,600,1200,1800,2400,4800,9600,19200,38400,57600,115200,230400,460800,5e5,576e3,921600,1e6,1152e3,15e5,2e6,25e5,3e6,35e5,4e6],l=[{label:"RTU slave",value:"rtu-slave"},{label:"ASCII slave",value:"ascii-slave"},{label:"RTU master",value:"rtu-master"},{label:"ASCII master",value:"ascii-master"}],u=[{label:"1N - 1 stop bit, no parity",value:"1N"},{label:"1E - 1 stop bit, even parity",value:"1E"},{label:"1O - 1 stop bit, odd parity",value:"1O"},{label:"2N - 2 stop bits, no parity",value:"2N"}];function d(e){let{deviceId:t,funcCode:n,customPayload:a,address:o,quantity:c,value:l,subFunction:u,payload:d}=e,p="".concat(t.toString(16).padStart(2,"0"));if(a)p+="".concat(n.toString(16).padStart(2,"0"))+"".concat((0,r.uv)(d||""));else switch(p+="".concat(n.toString(16).padStart(2,"0")),n){case 1:case 2:case 3:case 4:p+="".concat((o||0).toString(16).padStart(4,"0"))+"".concat((c||0).toString(16).padStart(4,"0"));break;case 5:case 6:p+="".concat((o||0).toString(16).padStart(4,"0"))+"".concat((l||0).toString(16).padStart(4,"0"));break;case 7:case 11:case 12:case 17:break;case 8:p+="".concat((u||0).toString(16).padStart(2,"0"))+"".concat((0,r.uv)(d||""));break;case 15:p+="".concat((o||0).toString(16).padStart(4,"0"))+"".concat((c||0).toString(16).padStart(4,"0"))+"".concat(Math.ceil((d||"").length/4).toString(16).padStart(2,"0"))+"".concat((0,r.uv)(d||""));break;case 16:p+="".concat((o||0).toString(16).padStart(4,"0"))+"".concat((c||0).toString(16).padStart(4,"0"))+"".concat(Math.ceil((d||"").length/2).toString(16).padStart(2,"0"))+"".concat((0,r.uv)(d||""));break;default:p+="".concat((0,r.uv)(d||""))}let f=function(e){let t=65535;for(let n=0;n<e.length;n++)t=(s[(t^e[n])&255]^t>>8)&65535;return t<<8&65535|t>>8}(i.from(p,"hex")),g=f.toString(16).padStart(4,"0"),m=p;return[m+g,m,g]}function p(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=t.toString(16).padStart(4,"0"),[a,r,i]=d(e),o=Math.ceil(r.length/2).toString(16).padStart(4,"0");return["".concat(n,"0000").concat(o).concat(r),i]}function f(e){let[t,n]=d(e),a=n.toUpperCase().split("").map(e=>e.charCodeAt(0).toString(16).padStart(2,"0")).join(""),r=function(e){let t=0;for(let n=0;n<e.length;n++)t+=255&e[n];return(255^t)+1&255}(i.from(n,"hex")),o=r.toString(16).toUpperCase().split("").map(e=>e.charCodeAt(0).toString(16).padStart(2,"0")).join("");return["3A".concat(a).concat(o,"0D0A"),o]}async function g(e,t,n,o,s){let c=n.trim().toLowerCase().split("\n").map(e=>e.trim()),l=[],u=0,d=0,p=0,f=()=>{s&&s("Requests sent: ".concat(u,"\nResponses: ").concat(d,"\nErrors: ").concat(p))};for(let n of c){if(n.startsWith("#")||0===n.length)continue;let s=(0,r.uv)(n),c={dataB64:i.from(s,"hex").toString("base64"),asIs:o,dst:t};u++,f();let g=await (0,a.ri)(e,"/api/modbus/send-request/",{method:"POST",body:JSON.stringify(c)}),m=await g.json();m.dataB64?d++:p++,f(),l.push({request:s,response:m.dataB64?i.from(m.dataB64,"base64").toString("hex"):"Error: ".concat(m.modbusErrorCode)})}let g="";for(let e of l)g+="> ".concat(e.request,"\n< ").concat(e.response,"\n");return s&&s(g),l}async function m(e,t,n,a,r){let i=[],o=a,s=n;for(;o>0;){let n=Math.min(o,125),a=await h(e,t,s,n,r);i.push(...a),o-=n,s+=n}return i}async function h(e,t,n,a,r){let[i,o,s]=d({deviceId:r,funcCode:"holding"===t?3:4,address:n,quantity:a}),c=(await g(e,"VIR",o,!1))[0].response,l=[];for(let e=0;e<a;e++)l.push(parseInt(c.slice(6+4*e,10+4*e),16));return l}function v(e,t){let n;let[a,r,i,...o]=e.split(" "),[s,c]=a.split("-"),l=1e3*Number(s)+Number(c),u=new Date(r),d="".concat(u.toLocaleTimeString(),".").concat(u.getMilliseconds().toString().padStart(3,"0")),p="<"!==i&&">"!==i?"#":i,f=o.join(" ");if("#"===p)return{id:l,raw:e,date:d,type:"#",content:{kind:"raw",payload:f}};let g=Array.from(f.match(/.{1,2}/g));if(f.length%2!=0||"rtu"===t&&(f.length<8||f.length>254)||"ascii"===t&&(f.length<18||"3a"!==g[0]||"0d"!==g[g.length-2]||"0a"!==g[g.length-1])||"tcp"===t&&f.length<16)return{id:l,raw:e,date:d,type:p,content:{kind:"error",payload:g.join(" ")}};if("rtu"===t){let e=g.splice(-2).join(" ");n=Object.assign(S(g,p),{crc:e})}else if("ascii"===t){let e=parseInt(g.slice(3,5).map(e=>String.fromCharCode(parseInt(e,16))).join(""),16);n={kind:"correct",prefix:g[0],deviceId:g.slice(1,3).join(" "),functionCode:g.slice(3,5).join(" "),errorFunctionCode:e>=128,payload:g.slice(6,-4).join(" "),crc:g.slice(-4).join(" "),description:g.slice(1,-4).map(e=>String.fromCharCode(parseInt(e,16))).join("")}}else if("rtu-no-crc"===t)n=S(g,p);else{let e=parseInt(g[8],16);n={kind:"correct",prefix:g.slice(0,6).join(" "),deviceId:g[6],functionCode:g[7],errorFunctionCode:e>=128,payload:g.slice(8).join(" ")}}return{id:l,raw:e,date:d,type:p,content:n}}function S(e,t){let n=parseInt(e[1],16),a={kind:"correct",deviceId:e[0],functionCode:e[1],errorFunctionCode:n>=128,payload:e.slice(2).join(" ")};if(">"===t&&(3===n||4===n)){let t=parseInt(e.slice(2,4).join(""),16),r=parseInt(e.slice(4,6).join(""),16),i=3===n?"holding":"input";r>1?a.description="Read ".concat(i," ").concat(t,"-").concat(t+r-1):a.description="Read ".concat(i," ").concat(t)}if("<"===t&&(3===n||4===n)){let t=e.slice(3).join(""),n=t.match(/.{1,4}/g);if(n){let e=Array.from(n).map(e=>parseInt(e,16));a.description=e.join(", ")}}return a}},8688:function(e,t,n){"use strict";n.d(t,{$b:function(){return i},Cu:function(){return c},Mn:function(){return o},tz:function(){return l},v4:function(){return s}});var a=n(4579),r=n(4911);function i(){return(0,a.tQ)("/api/rs485-connections/",r.ph)}async function o(e){let t=(0,a.bH)();await (0,a.ri)(t,"/api/rs485-connection/".concat(e.deviceName,"/update/"),{method:"POST",body:JSON.stringify(e),timeoutMs:3e4})}async function s(e){let t=(0,a.bH)();await (0,a.ri)(t,"/api/rs485-connections/create/",{method:"POST",body:JSON.stringify(e),timeoutMs:3e4})}async function c(e){let t=(0,a.bH)();return await (0,a.ri)(t,"/api/rs485-connection/".concat(e,"/remove/"),{method:"POST",body:JSON.stringify({}),timeoutMs:3e4}),(0,r.ph)(["/api/rs485-connections/",t])}let l={deviceName:"ttyUSB0",mode:"rtu-master",uidRange:"1-255",responseTimeoutMs:300,baudRate:9600,stopAndParityBits:"2N",broadcastIsEnabled:!0,isEnabled:!0,gatewayGeneratedExceptions:{pathUnavalableCode:1,targetDeviceFailedToRespondCode:2},portOpenRetryPeriod:5}},5329:function(e,t,n){"use strict";n.d(t,{cH:function(){return s},rV:function(){return o},zQ:function(){return c}});var a=n(4579),r=n(4911);async function i(e){var t;let[n,a]=e,i=await (0,r.wv)(a,["global:time:timezone","global:time:useNtp"]),o=await (0,r.vn)(a,"/api/state/?keys=".concat("time:timezones"));return{timezone:i["global:time:timezone"]||"Etc/UTC",useNtp:"true"===i["global:time:useNtp"],timezonesList:(null===(t=o["time:timezones"])||void 0===t?void 0:t.split("\n"))||[],setTime:new Date}}function o(){let e=(0,a.tQ)("time-settings",i);return{...e}}function s(e){let t={"global:time:timezone":e.timezone,"global:time:useNtp":e.useNtp?"true":"false"};return t}async function c(e){let t=(0,a.bH)(),n=s(e);if(await (0,a.ri)(t,"/api/confs/set/",{method:"POST",body:JSON.stringify(n),timeoutMs:3e4}),!e.useNtp&&e.setTime){let n=e.setTime;await (0,a.ri)(t,"/api/set-time/",{method:"POST",body:JSON.stringify({time:n.toISOString()}),timeoutMs:3e4})}}},8781:function(e,t,n){"use strict";n.d(t,{A:function(){return o}});var a=n(4579),r=n(4911);async function i(e){let[t,n]=e,a="global:modelName,global:userProvidedDeviceName,global:quickSetupIsDone",i=await (0,r.vn)(n,"/api/confs/?keys=".concat(a));a="release:date,release:version,release:updateState,release:latestPatch:version,release:latestMinor:version,release:latestMajor:version,release:scheduledUpgradeToTag,manufacturer:modeEnabled";let o=await (0,r.vn)(n,"/api/state/?keys=".concat(a)),s="no-update";if(o["release:scheduledUpgradeToTag"]){let e=o["release:scheduledUpgradeToTag"],t=e.split("/");t.length>1&&(e=t[1]),s={kind:"scheduled",version:e}}else"disabled"===o["release:updateState"]?s="disabled":"no-repo"===o["release:updateState"]?s="no-repo":"dirty-repo"===o["release:updateState"]?s="dirty-repo":"broken-repo"===o["release:updateState"]?s="broken-repo":"available-update-patch"===o["release:updateState"]?s={kind:"available",version:o["release:latestPatch:version"]||"unknown version"}:"available-update-minor"===o["release:updateState"]?s={kind:"available",version:o["release:latestMinor:version"]||"unknown version"}:"available-update-major"===o["release:updateState"]?s={kind:"available",version:o["release:latestMajor:version"]||"unknown version"}:"imminent-upgrade"===o["release:updateState"]&&(s="upgrading");return{userProvidedName:i["global:userProvidedDeviceName"]||void 0,modelName:i["global:modelName"]||"OPCB",quickSetupIsDone:"true"===i["global:quickSetupIsDone"],manufacturerModeEnabled:"true"===o["manufacturer:modeEnabled"],firmwareVersion:o["release:version"]||"unknown",firmwareDate:o["release:date"]||"-",updateState:s}}function o(){return(0,a.tQ)("basic-settings",i)}},1318:function(e,t,n){"use strict";function a(e){if(0===e)return"0 B";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}function r(e){let t=0;e>59&&(t=Math.floor(e/60),e%=60);let n=0;t>59&&(n=Math.floor(t/60),t%=60);let a=0;n>23&&(a=Math.floor(n/24),n%=24);let r=[];return a>0&&r.push(a+"d"),(n>0||r.length>0)&&r.push(n+"h"),(t>0||r.length>0)&&r.push(t+"m"),r.push(e+"s"),r.join(" ")}function i(e){return e<100?"good":e<200?"medium":"bad"}function o(e){return e.replace(/[\s-:]/g,"").toLowerCase().trim()}function s(e){return e.trim().toLowerCase().match(/.{1,2}/g).join(" ")}n.d(t,{Ch:function(){return r},k:function(){return i},td:function(){return a},uv:function(){return o},zF:function(){return s}})},9552:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return B}});var a=n(6521),r=n(300),i=n(1876),o=n(641),s=n(5388),c=n(4894),l=n(5049),u=n(4670),d=n(2104),p=n(58),f=n(4584),g=n(5885),m=n(3126),h=(0,n(7557).Z)("corner-down-right","IconCornerDownRight",[["path",{d:"M6 6v6a3 3 0 0 0 3 3h10l-4 -4m0 8l4 -4",key:"svg-0"}]]),v=n(5914),S=n.n(v),b=n(5721),w=n(8519),y=n(7176),j=n(2579),C=n(6773),k=n(245),x=n(4579),R=n(3614),I=n(4911),E=n(6338),M=n(4099),N=n(8688),T=n(5329),P=n(8335),D=n(8781);function B(){let e=M.rV(),t=P.rV(),n=T.rV(),d=(0,x.pk)(),p=(0,D.A)();return e.data&&t.data&&n.data&&p.data?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(C.s,{dataLoaded:!0,dataErrored:!1}),(0,a.jsx)(S(),{children:(0,a.jsx)("title",{children:"OPCB :: Quick Setup"})}),(0,a.jsx)(r.W,{size:420,my:40,children:(0,a.jsxs)(s.K,{align:"center",children:[(0,a.jsx)(c.E,{src:"/media/opcb-top.png",width:150,height:150,alt:"OPCB"}),(0,a.jsx)(l.D,{align:"center",children:"OPCB :: Quick Setup"}),(0,a.jsx)(O,{lanSettings:e,wifiSettings:t,timeSettings:n,basicSettings:p}),(0,a.jsxs)(u.e,{href:"/",onClick:()=>{d.token&&d.setToken({...d.token,skipQuickSetup:!0})},children:[(0,a.jsx)(h,{size:14,style:{marginRight:"5px"}}),"Skip and proceed to full interface"]})]})})]}):(0,a.jsx)(r.W,{size:"lg",mih:400,py:"lg",children:(0,a.jsx)(i.Z,{position:"center",p:"xl",children:(0,a.jsx)(o.a,{})})})}let z=(0,d.k)(()=>({form:{width:"100%"}}));function O(e){var t;let{lanSettings:n,wifiSettings:r,timeSettings:i,basicSettings:o}=e;if(!n.data||!r.data||!i.data)throw Error("Data is required for QuickSetupForm.");let{classes:c}=z(),u="true"===(null===(t=document.cookie.split("; ").find(e=>e.startsWith("".concat("proxy","="))))||void 0===t?void 0:t.split("=")[1]),d=u?i.data.timezone:(0,R.X6)(),{actionHandler:h}=(0,w.vu)(),[v,S]=(0,b.useState)("elan"),C=(0,m.c)({initialValues:{elan:{...n.data},wlan:{...r.data},time:{...i.data,timezone:d},rs485:{...N.tz}},validate:{elan:{...M.Rx},wlan:{...P.Rx}}}),x=(0,y.u)(C),D=async()=>{await (0,I.NC)({...M.Up(C.values.elan),...P.Up(C.values.wlan),...T.cH(C.values.time),"global:quickSetupIsDone":"true"});try{await N.v4(C.values.rs485)}catch(e){await N.Mn(C.values.rs485)}await n.mutate(C.values.elan),await r.mutate(C.values.wlan),await i.mutate(C.values.time),await o.mutate()};return(0,a.jsx)("form",{className:c.form,onSubmit:C.onSubmit(async()=>{h({actionProcess:D,title:"Applying settings",failedTitle:"Setup failed.",failedId:"quick-setup-failed",startActionText:"Sending the settings to the device...",afterActionText:"Saving the settings...",successId:"quick-setup-success",successTitle:"Settings applied.",successMessage:"Internet connection, timezone and RS-485 connection saved in the device.",messageAfterDeviceWaitTimeout:(0,a.jsx)(w.zU,{}),redirectToDashboardAfterAction:!0,delayBeforeDeviceWait:5e3})}),children:(0,a.jsxs)(s.K,{spacing:"lg",children:[(0,a.jsxs)(s.K,{children:[(0,a.jsx)(l.D,{order:3,align:"center",children:"Internet Connection"}),(0,a.jsx)(p.s,{fullWidth:!0,data:[{value:"elan",label:"Ethernet"},{value:"wlan",label:"Wi-Fi"}],value:v,onChange:S}),"elan"===v?(0,a.jsx)(j.Z,{form:C}):(0,a.jsx)(k.Z,{form:C})]}),(0,a.jsxs)(s.K,{children:[(0,a.jsx)(l.D,{order:3,align:"center",children:"Timezone"}),(0,a.jsx)(f.Ph,{label:"Timezone:",data:C.values.time.timezonesList,...x("time.timezone"),searchable:!0})]}),(0,a.jsxs)(s.K,{children:[(0,a.jsx)(l.D,{order:3,align:"center",children:"RS-485"}),(0,a.jsx)(f.Ph,{label:"Mode:",data:E.EH,...x("rs485.mode")}),(0,a.jsx)(f.Ph,{label:"Baud rate:",data:E._.map(e=>({value:e.toString(),label:e.toString()})),...x("rs485.baudRate"),value:C.values.rs485.baudRate.toString(),onChange:e=>{C.setFieldValue("rs485.baudRate",parseInt(e||"9600",10))}}),(0,a.jsx)(f.Ph,{label:"Stop and parity bits:",data:E.J4,...x("rs485.stopAndParityBits")})]}),(0,a.jsx)(g.z,{type:"submit",children:"Save"})]})})}}},function(e){e.O(0,[634,733,105,156,957,774,888,179],function(){return e(e.s=4480)}),_N_E=e.O()}]);