"use strict";
/*
TOKEN=`curl -s -H "Content-Type: application/json" \
        -d '{"username": "admin", "password": "admin" }' \
        "http://localhost:4004/api/login/" | \
    jq -r ".token"` \
&& \
curl -s -S -d '{}' -H "Content-Type: application/json" \
    -H "Authorization: bearer $TOKEN" \
    "http://localhost:4004/api/tasks/78b3b511-a3ab-497d-aaef-73234fabe648/run/" | \
    jq -C
*/
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = exports.SCHEMA = void 0;
const opcb_ts_shared_1 = require("@overvis/opcb-ts-shared");
const server_tools_1 = require("@overvis/server-tools");
const typebox_1 = require("@sinclair/typebox");
const auth_1 = require("../auth");
const tasks_1 = require("../model/tasks");
const task_get_runs_1 = require("./task-get-runs");
const OK_RESPONSE_SCHEMA = typebox_1.Type.Union([
    typebox_1.Type.Object({ result: typebox_1.Type.Literal("ok") }),
    typebox_1.Type.Object({ result: typebox_1.Type.Literal("already-stopped") }),
    typebox_1.Type.Object({ result: typebox_1.Type.Literal("error"), error: typebox_1.Type.String() }),
]);
exports.SCHEMA = {
    params: task_get_runs_1.PARAMS_SCHEMA,
    response: (0, server_tools_1.apiResponse)(OK_RESPONSE_SCHEMA),
};
async function openHandler(req) {
    const runningIds = (0, tasks_1.getRunningTaskIds)(this.queries);
    if (!runningIds.includes(req.params.id)) {
        return { result: "already-stopped" };
    }
    const res = await this.bus.sendRequest(new opcb_ts_shared_1.redisCmd.TaskStop(req.params.id));
    if (res.error) {
        return { result: "error", error: res.error };
    }
    return { result: "ok" };
}
exports.handler = (0, auth_1.auth)("writeConfs", openHandler);
//# sourceMappingURL=task-stop.js.map