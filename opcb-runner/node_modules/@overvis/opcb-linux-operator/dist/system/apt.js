"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ensureAptDependenciesAreInstalled = void 0;
const exec_1 = require("../exec");
const __1 = require("..");
async function ensureAptDependenciesAreInstalled() {
    __1.logger.debug("Ensuring apt dependencies are installed...");
    const packages = [
        "git",
        "hostapd",
        "dnsmasq",
        "resolvconf",
        "network-manager",
        "wireguard",
        "nginx",
        "qrencode",
        "imagemagick",
        "systemd-timesyncd",
    ];
    const pkgs = packages.join(" ");
    const res = await (0, exec_1.exec)(`dpkg-query -f '\${Package} \${Status}\\n' -W ${pkgs} 2> /dev/null | ` +
        `awk '$NF == "installed"{print $1}'`);
    const installedPackages = res
        .split("\n")
        .filter((x) => x)
        .map((v) => v.trim());
    const missingPackages = packages.filter((x) => !installedPackages.includes(x));
    if (missingPackages.length === 0) {
        return;
    }
    __1.logger.warn(`Missing apt packages: ${missingPackages.join(", ")}`);
    __1.logger.info(`Running apt-get update...`);
    await (0, exec_1.exec)("apt-get", ["update"], "info");
    __1.logger.info(`Installing missing packages...`);
    await (0, exec_1.exec)(`DEBIAN_FRONTEND=noninteractive apt-get install -y ${missingPackages.join(" ")}`, [], "info");
}
exports.ensureAptDependenciesAreInstalled = ensureAptDependenciesAreInstalled;
//# sourceMappingURL=apt.js.map