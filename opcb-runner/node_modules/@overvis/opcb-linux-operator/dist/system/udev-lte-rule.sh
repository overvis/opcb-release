#!/bin/bash

# echo $DEVPATH # /devices/platform/soc/1c1c000.usb/usb4/4-1
# echo $BUSNUM # 004
# echo $DEVNUM # 041
# echo $ID_VENDOR_ID # 3566
# echo $ID_MODEL_ID # 2001

# set -e

{

echo "Got device: $DEVPATH (BUSNUM=$BUSNUM, DEVNUM=$DEVNUM, ID_VENDOR_ID=$ID_VENDOR_ID, ID_MODEL_ID=$ID_MODEL_ID)"
IC=$(grep -h . /sys$DEVPATH/*:1.0/bInterfaceClass)
echo "InterfaceClass: $IC"

USB_ID=$(basename $DEVPATH)
LOCKFILE=/var/run/usb.$USB_ID-$ID_VENDOR_ID-$ID_MODEL_ID-$IC.lock
if [[ -e $LOCKFILE ]]
then
    LOCKFILE_AGE=$(( $(date +%s ) - $(stat  $LOCKFILE -c %Y) ))
fi
if [[ -n $LOCKFILE_AGE ]] && [[ $LOCKFILE_AGE -lt 5 ]]
then
    echo "Device $DEVPATH was processed recently, skipping..."
    exit 0
fi
set > $LOCKFILE

DEV_CLASS="$ID_VENDOR_ID:$ID_MODEL_ID:$IC"
case $DEV_CLASS in
# "3566:2001:08")
#     echo "Found Brovi E3372-325 in Storage mode..."
#     CMD="usb_modeswitch -b $BUSNUM -g $DEVNUM -v $ID_VENDOR_ID -p $ID_MODEL_ID -X"
#     echo "===== run: $CMD"
#     $CMD
#     ;;
"3566:2001:e0")
    echo "Found Brovi E3372-325 in RNDIS mode. Resetting to prevent automatic mode switch to storage..."
    CMDS=(
        "usb_modeswitch -b $BUSNUM -g $DEVNUM -v $ID_VENDOR_ID -p $ID_MODEL_ID -W -R -w 400"
        "usb_modeswitch -b $BUSNUM -g $DEVNUM -v $ID_VENDOR_ID -p $ID_MODEL_ID -W -R"
    )
    i=0
    for CMD in "${CMDS[@]}"
    do
        i=$(($i+1))
        echo "===== STEP $i, run: $CMD"
        $CMD
    done

    # ip link set enxbefbe2a5bddd up
    # dhclient enxbefbe2a5bddd
    ;;
"12d1:1f01:08")
    echo "Found Huawei E353/E3131 in Mass Storage mode. Switching to CDC Ethernet mode..."
    CMD="usb_modeswitch -b $BUSNUM -g $DEVNUM -v $ID_VENDOR_ID -p $ID_MODEL_ID -W -J"
    echo "===== run: $CMD"
    $CMD
    ;;
*)
    echo "Unknown device class: $DEV_CLASS, skipping..."
    ;;
esac

} 2>&1 | logger -t opcb-udev-lte

# Follow log: journalctl -f -t opcb-udev-lte
