"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ensureUdevIsConfigured = void 0;
const tslib_1 = require("tslib");
const __1 = require("..");
const exec_1 = require("../exec");
const fs = tslib_1.__importStar(require("fs"));
async function ensureUdevIsConfigured() {
    __1.logger.debug("Ensuring udev rule for LTE modems is configured...");
    const scriptFileContents = await fs.promises.readFile(__dirname + "/udev-lte-rule.sh", "utf8");
    const scriptPath = "/etc/udev/rules.d/40-lte.sh";
    await (0, exec_1.ensureFileContents)(scriptPath, scriptFileContents, 0o754);
    const fileContents = `
ACTION!="add", GOTO="modeswitch_rules_end"
SUBSYSTEM!="usb", GOTO="modeswitch_rules_end"

# All known install partitions are on interface 0
ATTRS{bInterfaceNumber}!="00", GOTO="modeswitch_rules_end"

GOTO="modeswitch_rules_begin"

LABEL="modeswitch_rules_begin"
ATTR{idVendor}!="", ATTR{idProduct}!="", RUN+="/etc/udev/rules.d/40-lte.sh"
LABEL="modeswitch_rules_end"

SUBSYSTEM=="net", ACTION=="add",  ATTRS{idVendor}=="3566", ATTRS{idProduct}=="2001", NAME="wwan_brovi"
# ignore AT ports on interfaces 2,4 for ModemManager cuz they stuck for some reason
SUBSYSTEM=="tty", ACTION=="add", DEVPATH=="*:1.[24]/*", ATTRS{idVendor}=="3566", ATTRS{idProduct}=="2001", ENV{ID_MM_PORT_IGNORE}="1"
`;
    const changed = await (0, exec_1.ensureFileContents)("/etc/udev/rules.d/40-lte.rules", fileContents);
    await (0, exec_1.ensureServiceState)("systemd-udevd", true, changed ? "rule 40-lte.rules changed" : undefined);
}
exports.ensureUdevIsConfigured = ensureUdevIsConfigured;
//# sourceMappingURL=udev.js.map