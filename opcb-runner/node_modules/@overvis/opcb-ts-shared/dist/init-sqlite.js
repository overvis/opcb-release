"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
/* eslint-disable no-console */
var fs = tslib_1.__importStar(require("fs"));
var sqlite_1 = require("./sqlite");
function run() {
    var userDir = process.argv[2] || ".";
    var opcbDb = userDir + "/opcb.sqlite3";
    if (fs.existsSync(opcbDb)) {
        var memDb_1 = (0, sqlite_1.connectSqlite)(opcbDb);
        memDb_1.unsafeMode(true);
        memDb_1.exec("\n            pragma writable_schema = 1;\n            delete from sqlite_master;\n            pragma writable_schema = 0;\n            vacuum;\n            pragma integrity_check;");
        memDb_1.close();
    }
    (0, sqlite_1.migrateDb)(opcbDb, console);
    var opcbMemDb = userDir + "/opcb-mem.sqlite3";
    if (fs.existsSync(opcbMemDb)) {
        var memDb_2 = (0, sqlite_1.connectSqlite)(opcbMemDb);
        memDb_2.unsafeMode(true);
        memDb_2.exec("\n            pragma writable_schema = 1;\n            delete from sqlite_master;\n            pragma writable_schema = 0;\n            vacuum;\n            pragma integrity_check;");
        memDb_2.close();
    }
    (0, sqlite_1.initMemDb)(opcbMemDb, undefined, false);
    var fixturePath = process.argv[3] || "./sqlite-fixtures/dev";
    var dbFixtureFile = "".concat(fixturePath, "/opcb.sql");
    console.log("Applying fixture to persistent db: ".concat(dbFixtureFile));
    var dbFixture = fs.readFileSync(dbFixtureFile, "utf-8");
    var db = (0, sqlite_1.connectSqlite)(opcbDb);
    db.exec(dbFixture);
    var memDbFixtureFile = "".concat(fixturePath, "/opcb-mem.sql");
    console.log("Applying fixture to mem db: ".concat(memDbFixtureFile));
    var memDbFixture = fs.readFileSync(memDbFixtureFile, "utf-8");
    var memDb = (0, sqlite_1.connectSqlite)(opcbMemDb);
    memDb.exec(memDbFixture);
}
run();
//# sourceMappingURL=init-sqlite.js.map