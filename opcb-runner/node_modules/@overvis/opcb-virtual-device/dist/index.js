"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.run = exports.logger = void 0;
const opcb_ts_shared_1 = require("@overvis/opcb-ts-shared");
const handlers_1 = require("./handlers");
const parameter_1 = require("./parameter");
const virtual_params_1 = require("./virtual-params");
async function run(setLogger, runConf) {
    exports.logger = setLogger;
    exports.logger.info("Starting...");
    const db = (0, opcb_ts_shared_1.connectSqlite)(runConf.sqliteDbPath, runConf.sqliteLibDir);
    const configData = {
        isEnabled: false,
        uid: 111,
    };
    // initializing bus
    const bus = runConf.redisClient;
    const configMap = (0, parameter_1.createAddressParamMap)(opcb_ts_shared_1.CONFIG_SCHEMA, new Map(), "config");
    const stateMap = (0, parameter_1.createAddressParamMap)(opcb_ts_shared_1.STATE_SCHEMA, new Map(), "state");
    const virtParamsMap = (0, parameter_1.createAddressParamMap)(virtual_params_1.VIRTUAL_PARMAS_SCHEMA, new Map(), "state");
    await bus.setState({
        "virtualDevice:modbusParameters": JSON.stringify([
            ...(0, parameter_1.createModbusParameters)(opcb_ts_shared_1.CONFIG_SCHEMA, "config", []),
            ...(0, parameter_1.createModbusParameters)(opcb_ts_shared_1.STATE_SCHEMA, "state", []),
            ...(0, parameter_1.createModbusParameters)(virtual_params_1.VIRTUAL_PARMAS_SCHEMA, "state", []),
            ...(0, parameter_1.createModbusUserParameters)(),
        ]),
    });
    bus.registerRequestHandler("sync-config", (0, handlers_1.createSyncConfigHandler)({
        bus,
        configData,
        db,
    }));
    bus.registerPartialRequestHandler("modbus-req", (0, handlers_1.createModbusRequestHandler)({
        bus,
        configData,
        db,
    }, configMap, stateMap, virtParamsMap));
    exports.logger.info("Started.");
}
exports.run = run;
//# sourceMappingURL=index.js.map